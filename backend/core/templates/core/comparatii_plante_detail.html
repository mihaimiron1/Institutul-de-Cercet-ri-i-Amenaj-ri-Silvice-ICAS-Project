{% extends "base.html" %}
{% block title %}Comparare Plante Rare · {{ r.name }} · ResNat{% endblock %}
{% block content %}
<section id="comparatii-plante" class="container">
  <header class="hero">
    <h1>{{ r.name }}</h1>
    <p class="muted">{{ r.raion|default:"—" }}</p>
  </header>

  <!-- Controls card -->
  <div class="card" id="cmp-controls" data-mode="{{ mode|default:'years' }}">
    <!-- Mode selection -->
    <div class="mode-selector">
      <div class="btn-group" role="group" aria-label="Selectează modul de comparație">
        <button id="btnByYears" class="btn" aria-pressed="true" data-mode="years">
          Comparație pe ani
        </button>
        <button id="btnByReserve" class="btn btn-outline" data-mode="reserves">
          Comparație cu alte rezervații
        </button>
      </div>
    </div>

    <!-- Years mode controls -->
    <div id="yearsInline" class="mode-controls">
      <div class="control-group">
        <button id="yearsBtn" class="btn btn-outline" type="button" aria-haspopup="true" aria-expanded="false" aria-controls="yearsMenu">
          Selectează anii
        </button>
        <div class="muted" id="yearsSummary"></div>
      </div>
    </div>

    <!-- Reserves mode controls -->
    <div id="resInline" class="mode-controls" style="display:none;">
      <!-- Single row form layout -->
      <div class="form-row">
        <!-- Base year selection -->
        <div id="baseYearBox" class="form-field">
          <label class="label" for="baseYearSelect">An de bază</label>
          <select id="baseYearSelect" class="form-select fullw">
            <option value="">— Selectează anul —</option>
          </select>
          <div id="baseYearHelper" class="helper-text" style="display:none;">
            Selectează anul de bază pentru comparație
          </div>
        </div>

        <!-- Reserve selector -->
        <div id="reserve-combobox" class="form-field">
          <label class="label" for="reserveSearch">Rezervație</label>
          <input
            id="reserveSearch"
            class="form-control fullw"
            type="text"
            inputmode="search"
            placeholder="Caută rezervație…"
            autocomplete="off"
            aria-haspopup="listbox"
            aria-expanded="false"
            aria-controls="reserveMenu"
            aria-autocomplete="list"
          />
          <input type="hidden" id="reserveValue" />
          <ul id="reserveMenu" class="combo-menu hidden" role="listbox" tabindex="-1" aria-label="Sugestii rezervație"></ul>
            <script id="reserves-data" type="application/json">
              {% autoescape off %}
              [
                {% for rr in all_reserves %}
                  "{{ rr.name|escapejs }}"{% if not forloop.last %},{% endif %}
                {% endfor %}
              ]
              {% endautoescape %}
            </script>
            <script id="reserve-id-map" type="application/json">
              {% autoescape off %}
              {
                {% for rr in all_reserves %}
                  "{{ rr.name|escapejs }}": {{ rr.id }}{% if not forloop.last %},{% endif %}
                {% endfor %}
              }
              {% endautoescape %}
            </script>
            <script id="id-name-map" type="application/json">
              {% autoescape off %}
              {
                {% for rr in all_reserves %}
                  "{{ rr.id }}": "{{ rr.name|escapejs }}"{% if not forloop.last %},{% endif %}
                {% endfor %}
              }
              {% endautoescape %}
            </script>
        </div>
        
        <!-- Year selector -->
        <div id="yearBoxSelected" class="form-field">
          <label class="label" for="yearSelect">An</label>
          <select id="yearSelect" class="form-select fullw">
            <option value="">— Selectează anul —</option>
          </select>
          <div id="yearHelper" class="helper-text" style="display:none;">
            Selectează rezervația și anul
          </div>
        </div>
        
        <!-- Add button -->
        <div class="form-field form-field-button">
          <label class="label">&nbsp;</label>
          <button id="addPair" class="btn" type="button" disabled>
            Adaugă
          </button>
        </div>
        
        <!-- Selected reservations chips -->
        <div class="selected-reserves" id="pairsChips">
          <!-- Chips will be added here dynamically -->
        </div>
      </div>
      
      <!-- Helper messages -->
      <div id="duplicateHelper" class="helper-text error" style="display:none;">
        Această rezervație a fost deja adăugată
      </div>
    </div>
  </div>

    <!-- Year picker popover -->
    <div id="yearsMenu" class="years-picker" role="group" aria-label="Selectează anii" style="position:absolute; margin-top:8px; max-height:300px; overflow:auto; display:none; z-index:1000; right:0; min-width:280px;">
      {% if available_years %}
        <div class="picker-header">
          <h4>Selectează anii pentru comparație</h4>
          <p class="muted">Alege între 2 și 4 ani</p>
        </div>
        <div class="picker-options">
          {% for y in available_years %}
          <label class="year-option">
            <input type="checkbox" class="yearOpt" value="{{ y }}" {% if y in selected_years %}checked{% endif %} />
            <span class="year-label">{{ y }}</span>
          </label>
          {% endfor %}
        </div>
        <div class="picker-actions">
          <button id="yearsApply" class="btn" type="button">
            Aplică selecția
          </button>
          <button id="yearsCancel" class="btn btn-outline" type="button">
            Anulează
          </button>
        </div>
        <div id="yearsValidation" class="validation-message" aria-live="polite"></div>
      {% else %}
        <div class="empty-state">
          <p class="muted">Nu există ani disponibili pentru specii rare în această rezervație.</p>
        </div>
      {% endif %}
    </div>

  <!-- Results section -->
  <div id="results-section">
    {% if available_years|length < 2 and mode == 'years' %}
      <div class="card empty-state-card">
        <div class="empty-state">
          <h3>Date insuficiente</h3>
          <p class="muted">Această rezervație nu are suficiente date pentru comparație pe ani. Este nevoie de cel puțin 2 ani cu specii rare.</p>
          <div class="mt-3">
            <a href="{% url 'comparatii_plante_list' %}" class="btn btn-outline">
              Înapoi la rezervații
            </a>
          </div>
        </div>
      </div>
    {% elif mode == 'years' %}
      {% if has_valid_selection %}
        <div class="card results-card">
          <div class="results-header">
            <h3>Comparație pe ani</h3>
            <div class="results-summary">
              <span class="summary-item">
                Ani: {{ selected_years|join:", " }}
              </span>
              <span class="summary-item">
                Specii: {{ total_species }}
              </span>
            </div>
          </div>
          
          <div class="table-container">
            <table class="comparison-table">
              <thead>
                <tr>
                  <th class="species-column">Specie (științific)</th>
                  {% for y in selected_years %}
                    <th class="year-column">{{ y }}</th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for row in rows %}
                <tr>
                  <td class="species-cell">
                    <a href="{% url 'viz_specii_detail' row.species_id %}" class="species-link">
                      {{ row.species_name }}
                    </a>
                  </td>
                  {% for present in row.presence %}
                    <td class="presence-cell">
                      {% if present %}
                        <span class="presence-indicator present">✓</span>
                      {% else %}
                        <span class="presence-indicator absent">—</span>
                      {% endif %}
                    </td>
                  {% endfor %}
                </tr>
                {% empty %}
                <tr>
                  <td colspan="{{ selected_years|length|add:1 }}" class="empty-row">
                    <div class="empty-state-inline">
                      Nu există date pentru anii selectați
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          {% if paginator and paginator.num_pages > 1 %}
          <div class="pagination-container">
            <nav class="pagination" aria-label="Paginare specii">
              <div class="pagination-controls">
                {% if page_obj.has_previous %}
                  <a class="btn btn-outline" href="?years={{ selected_years|join:"," }}&page={{ page_obj.previous_page_number }}">
                    Înapoi
                  </a>
                {% else %}
                  <button class="btn btn-outline" disabled>
                    Înapoi
                  </button>
                {% endif %}
                <span class="pagination-info">
                  Pagina {{ page_obj.number }} din {{ paginator.num_pages }}
                </span>
                {% if page_obj.has_next %}
                  <a class="btn" href="?years={{ selected_years|join:"," }}&page={{ page_obj.next_page_number }}">
                    Înainte
                  </a>
                {% else %}
                  <button class="btn" disabled>
                    Înainte
                  </button>
                {% endif %}
              </div>
            </nav>
          </div>
          {% endif %}
        </div>
      {% else %}
        <div class="card empty-state-card">
          <div class="empty-state">
            <h3>Selectează anii</h3>
            <p class="muted">Alege între 2 și 4 ani pentru a vedea comparația speciilor rare.</p>
          </div>
        </div>
      {% endif %}
    {% endif %}

    {% if mode == 'reserves' %}
      <div class="card results-card">
        <div class="results-header">
          <h3>Comparație cu alte rezervații</h3>
          {% if columns and rows_res %}
            <div class="results-summary">
              <span class="summary-item">
                Rezervații: {{ columns|length }}
              </span>
              <span class="summary-item">
                Specii: {{ rows_res|length }}
              </span>
            </div>
          {% endif %}
        </div>
        
        {% if columns and rows_res %}
          <div class="table-container">
            <table class="comparison-table">
              <thead>
                <tr>
                  <th class="species-column">Specie (științific)</th>
                  {% for col in columns %}
                    <th class="reserve-column">{{ col.reserve_name }} ({{ col.year }})</th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for row in rows_res %}
                <tr>
                  <td class="species-cell">
                    <a href="{% url 'viz_specii_detail' row.species_id %}" class="species-link">
                      {{ row.species_name }}
                    </a>
                  </td>
                  {% for present in row.presence %}
                    <td class="presence-cell">
                      {% if present %}
                        <span class="presence-indicator present">✓</span>
                      {% else %}
                        <span class="presence-indicator absent">—</span>
                      {% endif %}
                    </td>
                  {% endfor %}
                </tr>
                {% empty %}
                <tr>
                  <td colspan="{{ columns|length|add:1 }}" class="empty-row">
                    <div class="empty-state-inline">
                      Nu există date pentru selecția curentă
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="empty-state">
            <h3>Adaugă rezervații pentru comparație</h3>
            <p class="muted">Selectează anul de bază și adaugă cel puțin o altă rezervație cu anul său pentru a vedea comparația.</p>
          </div>
        {% endif %}
      </div>
    {% endif %}
  </div>

  <div class="mt-3" style="display:flex; gap:8px; justify-content:flex-start; align-items:center;">
    <a href="{% url 'comparatii_plante_list' %}" class="btn btn-outline">Înapoi la rezervații</a>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<style>
/* Enhanced styling for comparison page */
#comparatii-plante {
  --primary-color: #007bff;
  --success-color: #28a745;
  --warning-color: #ffc107;
  --danger-color: #dc3545;
  --light-bg: #f8f9fa;
  --border-color: #dee2e6;
  --text-muted: #6c757d;
  --shadow: 0 2px 4px rgba(0,0,0,0.1);
  --shadow-lg: 0 4px 12px rgba(0,0,0,0.15);
}

/* Mode selector styling */
.mode-selector {
  margin-bottom: 20px;
}

.mode-selector .btn-group {
  display: flex;
  gap: 0;
  border-radius: 8px;
  overflow: visible;
  
}

.mode-selector .btn {
  border-radius: 0;
  border-right: 1px solid var(--border-color);
  padding: 12px 20px;
  font-weight: 500;
  transition: all 0.2s ease;
}

.mode-selector .btn:first-child {
  border-top-left-radius: 8px;
  border-bottom-left-radius: 8px;
}

.mode-selector .btn:last-child {
  border-top-right-radius: 8px;
  border-bottom-right-radius: 8px;
  border-right: none;
}

.mode-selector .btn:hover {
  transform: translateY(-1px);
  box-shadow: var(--shadow-lg);
}

/* Mode controls */
.mode-controls {
  margin-top: 20px;
}

.control-group {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}

/* Single row form layout */
.form-row {
  display: flex;
  gap: 20px;
  align-items: flex-end;
  flex-wrap: nowrap;
  margin-bottom: 16px;
  height: 80px;
  min-height: 80px;
  max-height: 80px;
}

/* Form row with chips */
.form-row:has(.selected-reserves) {
  align-items: center;
  height: auto;
  min-height: 80px;
  max-height: none;
}

.form-field {
  position: relative;
  width: 200px;
  min-width: 200px;
  max-width: 200px;
  flex: 0 0 200px;
}

.form-field-button {
  flex: 0 0 auto;
  width: 120px;
  min-width: 120px;
  max-width: 120px;
}

.form-field .label {
  font-weight: 600;
  color: #495057;
  margin-bottom: 8px;
  display: block;
  font-size: 0.9rem;
  white-space: nowrap;
}

.form-field-button .label {
  visibility: hidden;
}

/* Helper text styling */
.helper-text {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  font-size: 0.8rem;
  padding: 4px 8px;
  border-radius: 4px;
  background: #fef3c7;
  border: 1px solid #fde68a;
  color: #92400e;
  margin-top: 4px;
  font-weight: 500;
}

.helper-text.error {
  position: static;
  margin-top: 8px;
  background: #fee2e2;
  border-color: #fecaca;
  color: #dc2626;
}


/* Consistent form control styling */
.form-field .form-select,
.form-field .form-control {
  height: 40px;
  font-size: 0.9rem;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  padding: 10px 12px;
  background-color: white;
  transition: all 0.2s ease;
  width: 100%;
  min-width: 100%;
  max-width: 100%;
  box-sizing: border-box;
}

.form-field .form-select:focus,
.form-field .form-control:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
}

.form-field .form-select:disabled,
.form-field .form-control:disabled {
  background-color: #f8f9fa;
  color: #6c757d;
  cursor: not-allowed;
  opacity: 0.7;
}


/* Button styling */
.form-field-button .btn {
  height: 40px;
  width: 100%;
  padding: 0 16px;
  font-size: 0.9rem;
  font-weight: 500;
  border-radius: 6px;
  transition: all 0.2s ease;
  box-sizing: border-box;
}

.form-field-button .btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Years picker styling */
.years-picker {
  background: white;
  border: 1px solid var(--border-color);
  border-radius: 12px;
  box-shadow: var(--shadow-lg);
  padding: 0;
  overflow: hidden;
}

.picker-header {
  padding: 16px;
  background: var(--light-bg);
  border-bottom: 1px solid var(--border-color);
}

.picker-header h4 {
  margin: 0 0 4px 0;
  font-size: 0.9rem;
  color: #495057;
  font-weight: 600;
}

.picker-header p {
  margin: 0;
  font-size: 0.8rem;
}

.picker-options {
  max-height: 200px;
  overflow-y: auto;
  padding: 8px 0;
}

.year-option {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  cursor: pointer;
  transition: background-color 0.2s ease;
}

.year-option:hover {
  background: #f8f9fa;
}

.year-option input[type="checkbox"] {
  width: 18px;
  height: 18px;
  accent-color: var(--primary-color);
}

.year-label {
  font-weight: 500;
  color: #495057;
}

.picker-actions {
  display: flex;
  gap: 8px;
  padding: 12px 16px;
  background: var(--light-bg);
  border-top: 1px solid var(--border-color);
}

.validation-message {
  padding: 8px 16px;
  font-size: 0.85rem;
  color: var(--danger-color);
  background: #f8d7da;
  border-top: 1px solid #f5c6cb;
}

/* Empty states */
.empty-state {
  text-align: center;
  padding: 40px 20px;
}

.empty-state-card {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border: 1px solid var(--border-color);
}

.empty-state h3 {
  margin: 0 0 12px 0;
  color: #495057;
  font-size: 1.25rem;
}

.empty-state p {
  margin: 0;
  color: var(--text-muted);
  max-width: 400px;
  margin-left: auto;
  margin-right: auto;
}

.empty-state-inline {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  color: var(--text-muted);
}

/* Results styling */
.results-card {
  border: 1px solid var(--border-color);
  border-radius: 12px;
  overflow: hidden;
  box-shadow: var(--shadow);
}

.results-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  background: var(--light-bg);
  border-bottom: 1px solid var(--border-color);
}

.results-header h3 {
  margin: 0;
  color: #495057;
  font-size: 1.25rem;
}

.results-summary {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
}

.summary-item {
  font-size: 0.9rem;
  color: var(--text-muted);
  padding: 4px 8px;
  background: rgba(0,0,0,0.05);
  border-radius: 4px;
}

/* Table styling */
.table-container {
  overflow-x: auto;
  background: white;
}

.comparison-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.9rem;
}

.comparison-table th {
  background: #f8f9fa;
  padding: 12px 16px;
  text-align: left;
  font-weight: 600;
  color: #495057;
  border-bottom: 2px solid var(--border-color);
  white-space: nowrap;
}

.species-column {
  min-width: 200px;
  position: sticky;
  left: 0;
  background: #f8f9fa;
  z-index: 1;
}

.year-column, .reserve-column {
  min-width: 80px;
  text-align: center;
}

.comparison-table td {
  padding: 12px 16px;
  border-bottom: 1px solid #f1f3f4;
}

.species-cell {
  position: sticky;
  left: 0;
  background: white;
  z-index: 1;
}

.species-link {
  color: var(--primary-color);
  text-decoration: none;
  font-weight: 500;
}

.species-link:hover {
  text-decoration: underline;
}

.presence-cell {
  text-align: center;
}

.presence-indicator {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  font-weight: bold;
  font-size: 0.9rem;
}

.presence-indicator.present {
  background: #d4edda;
  color: var(--success-color);
}

.presence-indicator.absent {
  background: #f8d7da;
  color: var(--text-muted);
}

/* Pagination */
.pagination-container {
  padding: 16px 20px;
  background: var(--light-bg);
  border-top: 1px solid var(--border-color);
}

.pagination-controls {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
}

.pagination-info {
  font-size: 0.9rem;
  color: var(--text-muted);
  padding: 0 16px;
}

/* Selected reserves */
.selected-reserves {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
  margin-left: 20px;
  min-height: 40px;
  max-height: 120px;
  overflow-y: auto;
  padding: 8px;
  background: #f8f9fa;
  border-radius: 6px;
  border: 1px solid #e9ecef;
  flex: 1;
}

/* Reserve chips */
.reserve-chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 8px;
  background: #e3f2fd;
  border: 1px solid #90caf9;
  border-radius: 4px;
  font-size: 0.8rem;
  color: #1565c0;
  margin: 2px;
  animation: slideIn 0.3s ease;
  max-width: 200px;
}

.chip-content {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  flex: 1;
  font-weight: 500;
}

.chip-remove {
  background: #ff5722;
  color: white;
  border: none;
  border-radius: 50%;
  width: 16px;
  height: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 0.7rem;
  font-weight: bold;
  transition: all 0.2s ease;
  flex-shrink: 0;
}

.chip-remove:hover {
  background: #d32f2f;
  transform: scale(1.1);
}

/* Loading state */
.loading-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 40px 20px;
  text-align: center;
}

.spinner {
  width: 32px;
  height: 32px;
  border: 3px solid #f3f3f3;
  border-top: 3px solid var(--primary-color);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 16px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loading-state p {
  color: var(--text-muted);
  font-size: 0.9rem;
  margin: 0;
}


/* Combo-menu styling (exact match with filters page) */
#comparatii-plante .combo-menu {
  position: absolute;
  inset-inline-start: 0;
  top: calc(100% + 4px);
  z-index: 30;
  width: 100%;
  max-height: 200px;
  overflow-y: auto;
  background: #fff;
  border: 1px solid var(--border, #dfe3e6);
  border-radius: 8px;
  box-shadow: 0 6px 20px rgba(0,0,0,.07);
  padding: 4px 0;
}

#comparatii-plante .combo-menu li {
  list-style: none;
  padding: 8px 10px;
  cursor: pointer;
  white-space: nowrap;
}

#comparatii-plante .combo-menu li[aria-selected="true"],
#comparatii-plante .combo-menu li:hover { 
  background: #f2f6f8; 
}

#comparatii-plante .combo-menu::-webkit-scrollbar { 
  width: 6px; 
}

#comparatii-plante .combo-menu::-webkit-scrollbar-thumb { 
  background: #c7d0d6; 
  border-radius: 3px; 
}

#comparatii-plante .hidden { 
  display: none; 
}

/* Animations */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes fadeOut {
  from { opacity: 1; transform: translateY(0); }
  to { opacity: 0; transform: translateY(-10px); }
}

@keyframes slideIn {
  from { opacity: 0; transform: translateX(-20px) scale(0.8); }
  to { opacity: 1; transform: translateX(0) scale(1); }
}

@keyframes slideOut {
  from { opacity: 1; transform: translateX(0) scale(1); }
  to { opacity: 0; transform: translateX(20px) scale(0.8); }
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

/* Enhanced chip styling */
.reserve-chip {
  transition: all 0.2s ease;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.reserve-chip:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.reserve-chip .chip-content {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  flex: 1;
}

/* Loading states */
.loading {
  opacity: 0.6;
  pointer-events: none;
}

.loading::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 20px;
  height: 20px;
  margin: -10px 0 0 -10px;
  border: 2px solid #f3f3f3;
  border-top: 2px solid var(--primary-color);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

/* Responsive design */
@media (max-width: 768px) {
  .mode-selector .btn {
    padding: 10px 16px;
    font-size: 0.9rem;
  }
  
  .mode-controls {
    margin-top: 16px;
  }
  
  .control-group {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
  
  .form-row {
    flex-direction: column;
    gap: 16px;
    align-items: stretch;
  }
  
  .form-field {
    width: 100%;
    min-width: 100%;
    max-width: 100%;
    flex: none;
  }
  
  .form-field-button {
    width: 120px;
    min-width: 120px;
    max-width: 120px;
    align-self: flex-start;
  }
  
  .form-field-button .btn {
    width: 100%;
  }
  
  .results-header {
    flex-direction: column;
    gap: 12px;
    align-items: flex-start;
  }
  
  .results-summary {
    flex-direction: column;
    gap: 8px;
  }
  
  .reserve-chip {
    font-size: 0.8rem;
    padding: 6px 10px;
  }
  
  .years-picker {
    right: auto;
    left: 0;
    min-width: 240px;
  }
}
</style>
<script>
(function(){
  var btn = document.getElementById('yearsBtn');
  var menu = document.getElementById('yearsMenu');
  var applyBtn = document.getElementById('yearsApply');
  var cancelBtn = document.getElementById('yearsCancel');
  var validation = document.getElementById('yearsValidation');
  var summary = document.getElementById('yearsSummary');
  var byYears = document.getElementById('btnByYears');
  var byReserve = document.getElementById('btnByReserve');
  var controls = document.getElementById('cmp-controls');

  // Reserves-mode elements
  var reserveBox = document.getElementById('reserve-combobox');
  var reserveInput = document.getElementById('reserveSearch');
  var reserveMenu = document.getElementById('reserveMenu');
  var reservesDataEl = document.getElementById('reserves-data');
  var yearSelect = document.getElementById('yearSelect');
  var addPair = document.getElementById('addPair');
  var pairsChips = document.getElementById('pairsChips');
  var baseYearSelect = document.getElementById('baseYearSelect');
  var baseYearHelper = document.getElementById('baseYearHelper');
  var yearHelper = document.getElementById('yearHelper');
  var duplicateHelper = document.getElementById('duplicateHelper');
  
  // Base year locking state
  var baseYearLocked = false;
  var baseReserveId = parseInt('{{ r.id }}', 10);
  
  // URL and session persistence functions
  function updateBaseYearInUrl(year) {
    var url = new URL(window.location);
    if (year) {
      url.searchParams.set('base_reserve', baseReserveId);
      url.searchParams.set('base_year', year);
    } else {
      url.searchParams.delete('base_reserve');
      url.searchParams.delete('base_year');
    }
    history.pushState({baseYear: year}, '', url);
  }
  
  function saveBaseYearToSession(year) {
    if (year) {
      sessionStorage.setItem('comparatii_base_year', year);
      sessionStorage.setItem('comparatii_base_reserve', baseReserveId);
    } else {
      sessionStorage.removeItem('comparatii_base_year');
      sessionStorage.removeItem('comparatii_base_reserve');
    }
  }
  
  function loadBaseYearFromStorage() {
    // Try URL first, then session storage
    var urlYear = '{{ base_year_url }}';
    var urlReserve = '{{ base_reserve_id_url }}';
    
    if (urlYear && urlReserve && parseInt(urlReserve) === baseReserveId) {
      return parseInt(urlYear);
    }
    
    var sessionYear = sessionStorage.getItem('comparatii_base_year');
    var sessionReserve = sessionStorage.getItem('comparatii_base_reserve');
    
    if (sessionYear && sessionReserve && parseInt(sessionReserve) === baseReserveId) {
      return parseInt(sessionYear);
    }
    
    return null;
  }
  
  function lockBaseYear() {
    if (baseYearSelect && baseYearSelect.value) {
      baseYearSelect.disabled = true;
      baseYearSelect.style.opacity = '0.7';
      baseYearSelect.style.cursor = 'not-allowed';
      baseYearLocked = true;
      updateBaseYearInUrl(baseYearSelect.value);
      saveBaseYearToSession(baseYearSelect.value);
    }
  }
  
  function unlockBaseYear() {
    if (baseYearSelect) {
      baseYearSelect.disabled = false;
      baseYearSelect.style.opacity = '1';
      baseYearSelect.style.cursor = 'default';
      baseYearLocked = false;
    }
  }


  function getSelected(){
    var els = menu ? menu.querySelectorAll('input.yearOpt:checked') : [];
    var vals = [];
    els.forEach(function(cb){ var v = parseInt(cb.value, 10); if (!isNaN(v)) vals.push(v); });
    return vals;
  }
  function validate(){
    var vals = getSelected();
    if (vals.length < 2) { 
      if (validation) validation.textContent = 'Alege cel puțin 2 ani.'; 
      return false; 
    }
    if (vals.length > 4) { 
      if (validation) validation.textContent = 'Poți alege maximum 4 ani.'; 
      return false; 
    }
    if (validation) validation.textContent = '';
    return true;
  }
  function toggleMenu(){
    var open = menu.style.display !== 'none';
    if (open){ 
      menu.style.display = 'none'; 
      btn.setAttribute('aria-expanded','false');
      btn.focus(); // Return focus to button
    } else { 
      menu.style.display = 'block'; 
      btn.setAttribute('aria-expanded','true'); 
      validate();
      // Focus first checkbox for keyboard navigation
      var firstCheckbox = menu.querySelector('input[type="checkbox"]');
      if (firstCheckbox) firstCheckbox.focus();
    }
  }
  if (btn && menu){
    btn.addEventListener('click', function(){ toggleMenu(); });
    cancelBtn && cancelBtn.addEventListener('click', function(){ menu.style.display='none'; btn.setAttribute('aria-expanded','false'); btn.focus(); });
    applyBtn && applyBtn.addEventListener('click', function(){ if (!validate()) return; var years = getSelected(); var url = new URL(window.location); url.searchParams.set('years', years.join(',')); window.location.assign(url.toString()); });
    document.addEventListener('click', function(e){ 
      const insideMenu = menu && menu.contains(e.target);
      const insideButton = btn && btn.contains(e.target);
      if (!insideMenu && !insideButton) {
        menu.style.display='none';
        btn.setAttribute('aria-expanded','false');
        btn.focus();
      }
    });
    menu.addEventListener('change', validate);
  }
  // hydrate summary text from current URL selection
  try {
    var sp = new URLSearchParams(location.search);
    var y = (sp.get('years')||'').split(',').filter(Boolean);
    if (y.length) { summary.textContent = 'Ani selectați: ' + y.join(', '); }
    // hydrate mode
    setMode(sp.get('mode') || 'years');
    
    // Ensure results section exists for reserves mode
    if ((sp.get('mode') || 'years') === 'reserves') {
      console.log('Initializing reserves mode');
      var resultsSection = document.getElementById('results-section');
      if (!resultsSection) {
        console.log('Creating results section');
        resultsSection = document.createElement('div');
        resultsSection.id = 'results-section';
        var controls = document.getElementById('cmp-controls');
        if (controls && controls.parentNode) {
          controls.parentNode.insertBefore(resultsSection, controls.nextSibling);
        }
      } else {
        console.log('Results section already exists');
      }
    }
    // hydrate reserves list from URL
    var basePair = sp.get('base');
    var resPairs = (sp.get('res')||'').split(',').filter(Boolean);
    // hydrate base year from URL
    if (basePair && basePair.includes(':')) {
      var parts = basePair.split(':');
      if (parts.length === 2 && parts[0] === '{{ r.id }}') {
        baseYearSelect.value = parts[1];
      }
    }
    // populate chips from URL (display only; full re-render on navigation)
    resPairs.forEach(function(pair){ 
      var parts = pair.split(':'); 
      if (parts.length===2){ 
        var rid=parseInt(parts[0],10); 
        var yy=parseInt(parts[1],10); 
        // Find reserve name by ID
        var reserveName = null;
        try {
          var idNameMapEl = document.getElementById('id-name-map');
          if (idNameMapEl) {
          var idToNameMap = JSON.parse(idNameMapEl.textContent);
          reserveName = idToNameMap[String(rid)];
          }
        } catch(e) {}
        if (reserveName){ 
          addChip(rid, reserveName, yy);
        } 
      }
    });
    
    // Lock base year if we have chips and base year is set
    if (resPairs.length > 0 && baseYearSelect && baseYearSelect.value) {
      lockBaseYear();
      // Fetch comparison data for existing chips
      setTimeout(function() {
        console.log('Loading chips from URL, fetching comparison data');
        fetchComparisonData();
      }, 100);
    }
  } catch(_) {}
  
  // Initialize base year from storage (only if not already set from URL)
  if (!baseYearSelect.value) {
    var storedBaseYear = loadBaseYearFromStorage();
    if (storedBaseYear) {
      baseYearSelect.value = storedBaseYear;
    }
  }
  
  window.addEventListener('popstate', function(){ location.reload(); });
  if (byYears) byYears.setAttribute('aria-pressed','true');

  function setMode(mode){
    controls.setAttribute('data-mode', mode);
    var url = new URL(window.location);
    url.searchParams.set('mode', mode);
    history.replaceState({mode:mode}, '', url);
    var showYears = (mode === 'years');
    document.getElementById('yearsInline').style.display = showYears ? 'flex' : 'none';
    document.getElementById('resInline').style.display = showYears ? 'none' : 'flex';
    byYears.className = showYears ? 'btn' : 'btn btn-outline';
    byReserve.className = showYears ? 'btn btn-outline' : 'btn';
    byYears.setAttribute('aria-pressed', String(mode === 'years'));
    byReserve.setAttribute('aria-pressed', String(mode === 'reserves'));
  }
  if (byYears) byYears.addEventListener('click', function(){ setMode('years'); });
  if (byReserve) byReserve.addEventListener('click', function(){ setMode('reserves'); });

  // Load base years when switching to reserves mode
  var originalSetMode = setMode;
  setMode = function(mode){
    originalSetMode(mode);
    if (mode === 'reserves') {
      loadBaseYears();
      // Initialize results section for reserves mode
      var resultsSection = document.getElementById('results-section');
      if (!resultsSection) {
        resultsSection = document.createElement('div');
        resultsSection.id = 'results-section';
        var controls = document.getElementById('cmp-controls');
        if (controls && controls.parentNode) {
          controls.parentNode.insertBefore(resultsSection, controls.nextSibling);
        }
      }
      // Show empty state initially
      hideComparisonTable();
    }
  };

  // Generic combobox initializer (exact copy from filters page)
  function initCombo(opts){
    var box    = document.getElementById(opts.boxId);
    if (!box) return;
    var input  = document.getElementById(opts.inputId);
    var menu   = document.getElementById(opts.menuId);
    var hidden = document.getElementById(opts.hiddenId);
    var dataEl = document.getElementById(opts.dataId);
    var raw = (dataEl && dataEl.textContent || '[]').trim();
    var ITEMS = [];
    try { ITEMS = JSON.parse(raw).filter(Boolean); } catch(e) { ITEMS = []; }

    function norm(s){ return (s||'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().trim(); }
    function candidates(q){ if (!q) return ITEMS.slice(0,20); var n=norm(q); return ITEMS.filter(function(name){ return norm(name).indexOf(n)!==-1; }).slice(0,20); }

    var activeIndex = -1;
    function render(list){
      while (menu.firstChild) menu.removeChild(menu.firstChild);
      if (!input.value && list.length === 0) {
        var li0 = document.createElement('li'); li0.textContent = '— alege —'; li0.setAttribute('aria-disabled','true'); menu.appendChild(li0);
      }
      list.forEach(function(name, i){
        var li = document.createElement('li'); li.setAttribute('role','option'); li.id = opts.menuId + '-opt-' + i; li.textContent = name; li.addEventListener('mousedown', function(e){ e.preventDefault(); select(name); }); menu.appendChild(li);
      });
      input.setAttribute('aria-expanded', String(list.length > 0));
      menu.classList.toggle('hidden', list.length === 0 && !!input.value);
      activeIndex = -1;
    }
    function select(name){ 
      input.value = name; 
      hidden.value = name; 
      // Find the reserve ID for the selected name
      var reserveId = null;
      try {
        var reserveMapEl = document.getElementById('reserve-id-map');
        if (reserveMapEl) {
          var reserveMap = JSON.parse(reserveMapEl.textContent);
          reserveId = reserveMap[name];
        }
      } catch(e) {}
      if (reserveId) {
        input.dataset.id = String(reserveId);
        fetchYearsFor(reserveId);
        setApplyEnabled();
      }
      close(); 
    }
    function close(){ menu.classList.add('hidden'); input.setAttribute('aria-expanded','false'); activeIndex=-1; }
    function openWith(q){ render(candidates(q)); menu.classList.remove('hidden'); }

    input.addEventListener('focus', function(){ openWith(input.value); });
    input.addEventListener('input', function(){ hidden.value=''; input.dataset.id=''; openWith(input.value); setApplyEnabled(); });
    input.addEventListener('keydown', function(e){
      var items = Array.from(menu.querySelectorAll('li[role="option"]'));
      if (menu.classList.contains('hidden') && (e.key==='ArrowDown' || e.key==='Enter')) { openWith(input.value); return; }
      if (!items.length) return;
      if (e.key==='ArrowDown'){ e.preventDefault(); activeIndex = Math.min(items.length-1, activeIndex+1); }
      else if (e.key==='ArrowUp'){ e.preventDefault(); activeIndex = Math.max(0, activeIndex-1); }
      else if (e.key==='Enter'){ e.preventDefault(); if (activeIndex>=0) select(items[activeIndex].textContent); else if (items.length) select(items[0].textContent); }
      else if (e.key==='Escape'){ close(); }
      items.forEach(function(li, i){ li.setAttribute('aria-selected', String(i===activeIndex)); });
      if (activeIndex>=0) {
        input.setAttribute('aria-activedescendant', opts.menuId + '-opt-' + activeIndex);
        items[activeIndex].scrollIntoView({ block: 'nearest' });
      } else {
        input.removeAttribute('aria-activedescendant');
      }
    });
    document.addEventListener('click', function(e){ if (!box.contains(e.target)) close(); });
  }

  // Initialize reserve combobox (exact same as filters page)
  initCombo({ boxId:'reserve-combobox', inputId:'reserveSearch', menuId:'reserveMenu', hiddenId:'reserveValue', dataId:'reserves-data' });

  function setApplyEnabled(){ 
    var hasBaseYear = baseYearSelect && baseYearSelect.value;
    var hasReserve = reserveInput && reserveInput.dataset.id;
    var hasYear = yearSelect && yearSelect.value;
    
    // If base year is locked, it's always considered "set"
    if (baseYearLocked) {
      hasBaseYear = true;
    }
    
    addPair.disabled = !(hasBaseYear && hasReserve && hasYear);
    
    // Show/hide helper texts
    if (!baseYearLocked && baseYearHelper) {
      baseYearHelper.style.display = (!hasBaseYear && (hasReserve || hasYear)) ? 'block' : 'none';
    }
    if (yearHelper) yearHelper.style.display = (hasBaseYear && (!hasReserve || !hasYear)) ? 'block' : 'none';
  }
  async function fetchYearsFor(rid){
    yearSelect.innerHTML = '<option value="">—</option>';
    try{
      var url = new URL('{% url "comparatii_plante_years" %}', window.location.origin);
      url.searchParams.set('res', String(rid));
      var resp = await fetch(url.toString(), { credentials:'same-origin' });
      var data = await resp.json();
      var years = (data.yearsByReserve && data.yearsByReserve[String(rid)]) || [];
      years.forEach(function(y){ var opt=document.createElement('option'); opt.value=String(y); opt.textContent=String(y); yearSelect.appendChild(opt); });
    } catch(_) {}
    setApplyEnabled();
  }
  // Load base years on mode switch
  async function loadBaseYears(){
    baseYearSelect.innerHTML = '<option value="">—</option>';
    try{
      var url = new URL('{% url "comparatii_plante_years" %}', window.location.origin);
      url.searchParams.set('base', '{{ r.id }}');
      var resp = await fetch(url.toString(), { credentials:'same-origin' });
      var data = await resp.json();
      var years = (data.yearsByReserve && data.yearsByReserve['{{ r.id }}']) || [];
      years.forEach(function(y){ var opt=document.createElement('option'); opt.value=String(y); opt.textContent=String(y); baseYearSelect.appendChild(opt); });
    } catch(_) {}
  }
  if (yearSelect){ yearSelect.addEventListener('change', setApplyEnabled); }
  if (baseYearSelect){ 
    baseYearSelect.addEventListener('change', function(){ 
      baseYearSelect.disabled = false;
      setApplyEnabled();
      // Save base year when changed
      if (baseYearSelect.value) {
        saveBaseYearToSession(baseYearSelect.value);
        updateBaseYearInUrl(baseYearSelect.value);
      }
    }); 
  }

  // Pairs management
  function addChip(rid, name, year){
    // prevent duplicates
    var existing = Array.from(pairsChips.querySelectorAll('[data-rid]')).some(function(el){ return parseInt(el.getAttribute('data-rid'),10)===rid; });
    if (existing) {
      if (duplicateHelper) {
        duplicateHelper.style.display = 'block';
        duplicateHelper.style.animation = 'fadeIn 0.3s ease';
      }
      setTimeout(function(){ 
        if (duplicateHelper) {
          duplicateHelper.style.animation = 'fadeOut 0.3s ease';
          setTimeout(function(){ duplicateHelper.style.display = 'none'; }, 300);
        }
      }, 3000);
      return;
    }
    if (duplicateHelper) duplicateHelper.style.display = 'none';
    
    // Create enhanced chip
    var chip = document.createElement('div');
    chip.setAttribute('data-rid', String(rid));
    chip.className = 'reserve-chip';
    
    var chipContent = document.createElement('span');
    chipContent.className = 'chip-content';
    chipContent.textContent = name + ' (' + year + ')';
    
    var removeBtn = document.createElement('button');
    removeBtn.className = 'chip-remove';
    removeBtn.innerHTML = '×';
    
    
    removeBtn.addEventListener('click', function(){ 
      chip.style.animation = 'slideOut 0.3s ease';
      setTimeout(function(){ 
        chip.remove(); 
        // Unlock base year if no chips remain
        var remainingChips = pairsChips.querySelectorAll('.reserve-chip');
        if (remainingChips.length === 0) {
          unlockBaseYear();
          // Keep base year in URL even when no chips
          if (baseYearSelect && baseYearSelect.value) {
            updateBaseYearInUrl(baseYearSelect.value);
          }
        }
        // Update URL without reloading
        syncUrlAndReload(); 
      }, 300);
    });
    
    chip.appendChild(chipContent);
    chip.appendChild(removeBtn);
    pairsChips.appendChild(chip);
    
    // Lock base year when first reservation is added
    if (baseYearSelect && baseYearSelect.value && !baseYearSelect.disabled) {
      lockBaseYear();
      // Save base year to session storage and URL
      saveBaseYearToSession(baseYearSelect.value);
      updateBaseYearInUrl(baseYearSelect.value);
    }
    
    // Trigger table refresh
    syncUrlAndReload();
  }
  function syncUrlAndReload(){
    var url = new URL(window.location);
    url.searchParams.set('mode','reserves');
    // Always include base year in URL if it exists
    var baseYear = baseYearSelect.value;
    if (baseYear) {
      url.searchParams.set('base', '{{ r.id }}:' + baseYear);
    } else {
      url.searchParams.delete('base');
    }
    // gather chips for res=
    var pairs = [];
    Array.from(pairsChips.querySelectorAll('[data-rid]')).forEach(function(el){
      var rid = parseInt(el.getAttribute('data-rid'),10);
      var text = el.textContent || '';
      var m = text.match(/\((\d{4})\)/);
      var yy = m ? m[1] : '';
      if (rid && yy) pairs.push(rid+':'+yy);
    });
    if (pairs.length) url.searchParams.set('res', pairs.join(',')); else url.searchParams.delete('res');
    
    // Update URL without reloading the page
    history.pushState({mode:'reserves'}, '', url);
    
    // Fetch and display comparison data
    fetchComparisonData();
  }
  
  function fetchComparisonData() {
    console.log('fetchComparisonData called');
    var baseYear = baseYearSelect.value;
    console.log('baseYear:', baseYear);
    if (!baseYear) {
      console.log('No base year, hiding table');
      hideComparisonTable();
      return;
    }
    
    var pairs = [];
    var chips = pairsChips.querySelectorAll('[data-rid]');
    console.log('Found chips:', chips.length);
    Array.from(chips).forEach(function(el){
      var rid = parseInt(el.getAttribute('data-rid'),10);
      var text = el.textContent || '';
      var m = text.match(/\((\d{4})\)/);
      var yy = m ? m[1] : '';
      console.log('Chip:', rid, yy, text);
      if (rid && yy) pairs.push(rid+':'+yy);
    });
    
    console.log('Pairs:', pairs);
    if (pairs.length === 0) {
      console.log('No pairs, hiding table');
      hideComparisonTable();
      return;
    }
    
    // Build URL for comparison data
    var url = new URL(window.location);
    url.searchParams.set('mode', 'reserves');
    url.searchParams.set('base', '{{ r.id }}:' + baseYear);
    url.searchParams.set('res', pairs.join(','));
    
    // Show loading state
    console.log('Showing loading state');
    showLoadingState();
    
    // Fetch the page content
    console.log('Fetching URL:', url.toString());
    fetch(url.toString())
      .then(response => {
        console.log('Response status:', response.status);
        return response.text();
      })
      .then(html => {
        console.log('HTML received, length:', html.length);
        // Parse the HTML to extract the table content
        var parser = new DOMParser();
        var doc = parser.parseFromString(html, 'text/html');
        var tableContainer = doc.querySelector('.results-card');
        
        console.log('Table container found:', !!tableContainer);
        if (tableContainer) {
          // Ensure results section exists
          var resultsSection = document.getElementById('results-section');
          if (!resultsSection) {
            console.log('Creating results section');
            resultsSection = document.createElement('div');
            resultsSection.id = 'results-section';
            // Insert after the form controls
            var controls = document.getElementById('cmp-controls');
            if (controls && controls.parentNode) {
              controls.parentNode.insertBefore(resultsSection, controls.nextSibling);
            }
          }
          
          // Update the results section with the table content
          console.log('Updating results section');
          resultsSection.innerHTML = tableContainer.outerHTML;
        } else {
          console.log('No table container, hiding table');
          hideComparisonTable();
        }
      })
      .catch(error => {
        console.error('Error fetching comparison data:', error);
        hideComparisonTable();
      });
  }
  
  function showLoadingState() {
    var resultsSection = document.getElementById('results-section');
    if (!resultsSection) {
      resultsSection = document.createElement('div');
      resultsSection.id = 'results-section';
      var controls = document.getElementById('cmp-controls');
      if (controls && controls.parentNode) {
        controls.parentNode.insertBefore(resultsSection, controls.nextSibling);
      }
    }
    
    resultsSection.innerHTML = `
      <div class="card results-card">
        <div class="results-header">
          <h3>Comparație cu alte rezervații</h3>
        </div>
        <div class="loading-state">
          <div class="spinner"></div>
          <p>Se încarcă datele de comparație...</p>
        </div>
      </div>
    `;
  }
  
  function hideComparisonTable() {
    var resultsSection = document.getElementById('results-section');
    if (!resultsSection) {
      resultsSection = document.createElement('div');
      resultsSection.id = 'results-section';
      var controls = document.getElementById('cmp-controls');
      if (controls && controls.parentNode) {
        controls.parentNode.insertBefore(resultsSection, controls.nextSibling);
      }
    }
    
    resultsSection.innerHTML = `
      <div class="card results-card">
        <div class="results-header">
          <h3>Comparație cu alte rezervații</h3>
        </div>
        <div class="empty-state">
          <h3>Adaugă rezervații pentru comparație</h3>
          <p class="muted">Selectează anul de bază și adaugă cel puțin o altă rezervație cu anul său pentru a vedea comparația.</p>
        </div>
      </div>
    `;
  }
  if (addPair){
    addPair.addEventListener('click', function(){
      var rid = parseInt(reserveInput.dataset.id||'',10);
      var name = reserveInput.value || '';
      var yy = parseInt(yearSelect.value||'',10);
      var baseYear = baseYearSelect.value;
      
      if (!baseYear) {
        if (baseYearHelper) baseYearHelper.style.display = 'block';
        if (baseYearSelect) baseYearSelect.focus();
        return;
      }
      
      if (!rid || !yy){ 
        if (yearHelper) yearHelper.style.display = 'block';
        if (!rid && reserveInput) reserveInput.focus();
        else if (!yy && yearSelect) yearSelect.focus();
        return; 
      }
      
      addChip(rid, name, yy);
      
      // Lock base year after first successful apply
      if (baseYearSelect.value) {
        lockBaseYear();
        updateBaseYearInUrl(baseYearSelect.value);
        saveBaseYearToSession(baseYearSelect.value);
      }
      
      // clear input for next
      reserveInput.value=''; reserveInput.dataset.id=''; yearSelect.innerHTML='<option value="">—</option>';
      setApplyEnabled();
      syncUrlAndReload();
    });
  }
})();
</script>
{% endblock %}

