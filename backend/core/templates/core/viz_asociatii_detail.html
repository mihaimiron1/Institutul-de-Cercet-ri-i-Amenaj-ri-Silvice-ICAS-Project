{% extends "base.html" %}
{% block title %}{{ a.name }} · ResNat{% endblock %}
{% block content %}
<section class="container">
  <header class="hero">
    <h1>{{ a.name }}</h1>
    <p class="muted">{{ a.category|default:"—" }}{% if a.subcategory %} · {{ a.subcategory }}{% endif %}</p>
  </header>

  <div class="card" id="association-card">
    <div class="grid" id="association-meta" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px 16px;">
      <div data-span="2" style="grid-column: span 2;">
        <strong>Nume</strong>
        <div class="muted" data-f="name">{{ a.name }}</div>
      </div>
      {% if a.raion %}
      <div>
        <strong>Raion</strong>
        <div class="muted" data-f="raion">{{ a.raion }}</div>
      </div>
      {% endif %}
      {% if a.amplasare %}
      <div data-span="2" style="grid-column: span 2;">
        <strong>Amplasare</strong>
        <div class="muted" data-f="amplasare">{{ a.amplasare }}</div>
      </div>
      {% endif %}
      {% if a.proprietar %}
      <div data-span="2" style="grid-column: span 2;">
        <strong>Proprietar</strong>
        <div class="muted" data-f="proprietar">{{ a.proprietar }}</div>
      </div>
      {% endif %}
      {% if a.category %}
      <div data-span="2" style="grid-column: span 2;">
        <strong>Categoria</strong>
        <div class="muted" data-f="category">{{ a.category }}</div>
      </div>
      {% endif %}
      {% if a.subcategory %}
      <div data-span="2" style="grid-column: span 2;">
        <strong>Subcategoria</strong>
        <div class="muted" data-f="subcategory">{{ a.subcategory }}</div>
      </div>
      {% endif %}

      {% if a.latitude and a.longitude %}
      <div>
        <strong>Coordonate</strong>
        <div class="muted" data-f="coords">{{ a.latitude }}, {{ a.longitude }}</div>
      </div>
      {% endif %}

      {% if a.notes %}
      <div data-span="2" style="grid-column: span 2;">
        <strong>Note</strong>
        <div class="muted" data-f="notes">{{ a.notes }}</div>
      </div>
      {% endif %}
    </div>

    <div class="mt-3" style="display:flex; gap:8px; justify-content:space-between; align-items:center;">
      <a href="{% url 'viz_asoc' %}" class="btn btn-outline">Înapoi la asociații</a>
      {% if is_admin %}
      <button id="actionBtn" class="btn" aria-label="Editează metadate" data-mode="view">Edit</button>
      {% endif %}
    </div>
  </div>

  {% if a.latitude and a.longitude %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <div id="association-map" data-lat="{{ a.latitude|floatformat:'6' }}" data-lon="{{ a.longitude|floatformat:'6' }}" style="width:100%; height:520px; margin-top:16px; border-radius:12px; overflow:hidden; box-shadow: var(--shadow);"></div>
  {% endif %}
</section>
{% endblock %}

{% block extra_css %}
<style>
  #association-meta input,
  #association-meta textarea { width: 100% !important; box-sizing: border-box; min-width: 0; }
  #association-meta > div { min-width: 0; overflow: hidden; max-width: 100%; word-wrap: break-word; }
  #association-meta textarea { transition: height 120ms ease; white-space: pre-wrap; overflow-wrap: anywhere; hyphens: auto; }
</style>
{% endblock %}

{% block extra_js %}
  {% if a.latitude and a.longitude %}
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    (function(){
      if (!document.getElementById('association-map')) return;
      if (window.__associationMapInit) return; window.__associationMapInit = true;
      var mapEl = document.getElementById('association-map');
      var lat = parseFloat(mapEl.getAttribute('data-lat'));
      var lon = parseFloat(mapEl.getAttribute('data-lon'));
      var mdCenter = [47.0, 28.5];
      var map = L.map('association-map', { center: [lat, lon] || mdCenter, zoom: 8, scrollWheelZoom: true });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
      var marker = L.marker([lat, lon]).addTo(map); marker.bindPopup(`{{ a.name|escapejs }}`); map.setView([lat, lon], 10);
    })();
  </script>
  {% endif %}
  {% if is_admin %}
  <script>
    (function(){
      var meta = document.getElementById('association-meta');
      var btn = document.getElementById('actionBtn');
      if (!btn) return;
      function getCookie(name){ var m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return m?m.pop():''; }
      function syncButton(){ var m=(btn.getAttribute('data-mode')||'view'); btn.innerHTML = (m==='edit')?'Save':'Edit'; }
      syncButton();
      btn.addEventListener('click', function(e){ e.preventDefault(); var m=(btn.getAttribute('data-mode')||'view'); if(m==='view'){ enterEdit(); } else { if(formEl) formEl.requestSubmit(); } });
      var formEl=null; var inputs={}; var originalValues={}; var dirty=false; var mode='VIEW';
      function autosize(t){ t.style.height='auto'; t.style.height=(t.scrollHeight||t.clientHeight)+'px'; }
      function createInput(field, isTextarea){ var el=meta.querySelector('[data-f="'+field+'"]'); if(!el) return; var val=(el.textContent.trim()==='—')?'':el.textContent.trim(); originalValues[field]=val; var input=isTextarea?document.createElement('textarea'):document.createElement('input'); if(isTextarea){ input.rows=1; input.style.cssText='width:100%; padding:8px; border:1px solid var(--line); border-radius:8px; font-family:inherit; font-size:inherit; resize:none; overflow:hidden;'; autosize(input);} else { input.type='text'; input.style.cssText='width:100%; padding:8px; border:1px solid var(--line); border-radius:8px; font-family:inherit; font-size:inherit;'; } input.name=field; input.value=val; el.replaceWith(input); inputs[field]=input; input.addEventListener('input', function(){ dirty = input.value.trim() !== (originalValues[field]||''); if(isTextarea) autosize(input); }); }
      function enterEdit(){ mode='EDITING'; btn.setAttribute('data-mode','edit'); syncButton(); if(!formEl){ formEl=document.createElement('form'); formEl.method='post'; formEl.addEventListener('submit', function(ev){ ev.preventDefault(); doSave(); }); meta.parentNode.insertBefore(formEl, meta); formEl.appendChild(meta);} createInput('name', true); createInput('notes', true); var first=inputs.name||inputs.notes; if(first) first.focus(); }
      async function doSave(){ var fd=new FormData(); fd.append('csrfmiddlewaretoken', getCookie('csrftoken')); Object.keys(inputs).forEach(function(k){ var curr=inputs[k].value.trim(); var orig=originalValues[k]||''; if(curr!==orig){ fd.append(k, curr); } }); try{ var resp=await fetch('{% url "update_association_meta" a.pk %}', { method:'POST', body: fd, headers:{'X-CSRFToken': getCookie('csrftoken')} }); if(!resp.ok){ throw new Error('Save failed'); } var data=await resp.json(); if(!data.ok){ throw new Error(data.error||'Save failed'); } } catch(e){ alert('Save error: '+e.message); } finally { // restore view
          Object.keys(inputs).forEach(function(field){ var display=document.createElement('div'); display.className='muted'; display.setAttribute('data-f', field); var v=(inputs[field].value||'').trim(); display.textContent = v===''?'—':v; inputs[field].replaceWith(display); }); inputs={}; originalValues={}; if(formEl && meta.parentNode===formEl){ formEl.parentNode.insertBefore(meta, formEl); formEl.remove(); formEl=null; } btn.setAttribute('data-mode','view'); syncButton(); mode='VIEW'; }
      }
    })();
  </script>
  {% endif %}
{% endblock %}


