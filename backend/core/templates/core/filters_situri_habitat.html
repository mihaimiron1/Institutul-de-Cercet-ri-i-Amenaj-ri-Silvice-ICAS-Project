{% extends "base.html" %}
{% block title %}Filtre · Situri – Habitat{% endblock %}
{% block content %}
<section id="situri-habitat" class="container">
  <header class="hero">
    <h1>Situri – Habitat</h1>
    <p class="muted">Aceleași filtre și rezultate ca în pagina Site–Habitat.</p>
  </header>

  <div class="card filters-panel">
    <form method="get" action="" class="filters-row">
      <label class="fullw" style="display:flex; flex-direction:column; gap:6px;">
        <span>Mod filtrare</span>
        <select name="mode" id="mode" class="form-select fullw">
          <option value="by_site"    {% if mode == 'by_site' %}selected{% endif %}>Habitate în site</option>
          <option value="by_habitat" {% if mode == 'by_habitat' %}selected{% endif %}>Site-uri pentru habitat</option>
          <option value="by_year"    {% if mode == 'by_year' %}selected{% endif %}>Toate în anul</option>
        </select>
      </label>

      <!-- Site combobox (hidden unless mode is by_site) -->
      <div class="fullw" id="site-combobox" style="position:relative; display:none;">
        <label class="label" for="siteSearch">Site</label>
        <input
          id="siteSearch"
          class="form-control fullw"
          type="text"
          inputmode="search"
          placeholder="Caută site…"
          autocomplete="off"
          aria-haspopup="listbox"
          aria-expanded="false"
          aria-controls="siteMenu"
          aria-autocomplete="list"
          value="{{ site_name|default_if_none:'' }}"
        />
        <input type="hidden" name="site_name" id="siteValue" value="{{ site_name|default_if_none:'' }}" />
        <ul id="siteMenu" class="combo-menu hidden" role="listbox" tabindex="-1" aria-label="Sugestii site"></ul>
        <script id="sites-data" type="application/json">{% autoescape off %}[{% for s in sites %}"{{ s|escapejs }}"{% if not forloop.last %},{% endif %}{% endfor %}]{% endautoescape %}</script>
      </div>

      <!-- Habitat combobox (hidden unless mode is by_habitat) -->
      <div class="fullw" id="habitat-combobox" style="position:relative; display:none;">
        <label class="label" for="habitatSearch">Habitat</label>
        <input
          id="habitatSearch"
          class="form-control fullw"
          type="text"
          inputmode="search"
          placeholder="Caută habitat…"
          autocomplete="off"
          aria-haspopup="listbox"
          aria-expanded="false"
          aria-controls="habitatMenu"
          aria-autocomplete="list"
          value="{{ habitat_name|default_if_none:'' }}"
        />
        <input type="hidden" name="habitat_name" id="habitatValue" value="{{ habitat_name|default_if_none:'' }}" />
        <ul id="habitatMenu" class="combo-menu hidden" role="listbox" tabindex="-1" aria-label="Sugestii habitat"></ul>
        <script id="habitats-data" type="application/json">{% autoescape off %}[{% for h in habitats %}"{{ h|escapejs }}"{% if not forloop.last %},{% endif %}{% endfor %}]{% endautoescape %}</script>
      </div>

      <div class="filters-actions">
        <button type="submit" class="btn">Caută</button>
      </div>
    </form>
  </div>

  <div class="muted prw-90 mt-4">
    {% if mode %}<span>Mod: <strong>{{ mode }}</strong></span>{% endif %}
    {% if site_name %} • <span>Site: <strong>{{ site_name }}</strong></span>{% endif %}
    {% if habitat_name %} • <span>Habitat: <strong>{{ habitat_name }}</strong></span>{% endif %}
  </div>

  <!-- Export action bar (centered) -->
  <div class="prw-results" style="margin-top: 10px; display:flex; align-items:center; justify-content:center; gap:10px;">
    <a class="btn btn-outline" href="?{{ request.GET.urlencode }}&export=csv">Export CSV</a>
    <a class="btn btn-outline" href="?{{ request.GET.urlencode }}&export=xlsx">Export XLSX</a>
  </div>

  <div class="card mt-4">
    {% if qs %}
      <div style="overflow:auto;">
        <table style="border-collapse:collapse; width:100%;">
          <thead>
            <tr>
              <th>Site</th>
              <th>Habitat (RO)</th>
              <th>Habitat (EN)</th>
              <th>Cod habitat</th>
              <th>An</th>
              <th>Suprafață (ha)</th>
              <th>Notițe</th>
            </tr>
          </thead>
          <tbody>
            {% for r in qs %}
            <tr>
              <td>{{ r.site.name }}</td>
              <td>{{ r.habitat.name_romanian }}</td>
              <td>{{ r.habitat.name_english }}</td>
              <td>{{ r.habitat.code }}</td>
              <td>{{ r.year }}</td>
              <td>{{ r.surface }}</td>
              <td>{{ r.notes }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="muted">Nimic de afișat. Alege un mod și completează criteriile.</p>
    {% endif %}
  </div>
</section>

{% block extra_js %}
<script>
  // Generic combobox initializer (same as Plante – Rezervații)
  function initCombo(opts){
    var box    = document.getElementById(opts.boxId);
    if (!box) return;
    var input  = document.getElementById(opts.inputId);
    var menu   = document.getElementById(opts.menuId);
    var hidden = document.getElementById(opts.hiddenId);
    var dataEl = document.getElementById(opts.dataId);
    var raw = (dataEl && dataEl.textContent || '[]').trim();
    var ITEMS = [];
    try { ITEMS = JSON.parse(raw).filter(Boolean); } catch(e) { ITEMS = []; }

    function norm(s){ return (s||'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().trim(); }
    function candidates(q){ if (!q) return ITEMS.slice(0,20); var n=norm(q); return ITEMS.filter(function(name){ return norm(name).indexOf(n)!==-1; }).slice(0,20); }

    var activeIndex = -1;
    function render(list){
      while (menu.firstChild) menu.removeChild(menu.firstChild);
      if (!input.value && list.length === 0) {
        var li0 = document.createElement('li'); li0.textContent = '— alege —'; li0.setAttribute('aria-disabled','true'); menu.appendChild(li0);
      }
      list.forEach(function(name, i){
        var li = document.createElement('li'); li.setAttribute('role','option'); li.id = opts.menuId + '-opt-' + i; li.textContent = name; li.addEventListener('mousedown', function(e){ e.preventDefault(); select(name); }); menu.appendChild(li);
      });
      input.setAttribute('aria-expanded', String(list.length > 0));
      menu.classList.toggle('hidden', list.length === 0 && !!input.value);
      activeIndex = -1;
    }
    function select(name){ input.value = name; hidden.value = name; close(); }
    function close(){ menu.classList.add('hidden'); input.setAttribute('aria-expanded','false'); activeIndex=-1; }
    function openWith(q){ render(candidates(q)); menu.classList.remove('hidden'); }

    input.addEventListener('focus', function(){ openWith(input.value); });
    input.addEventListener('input', function(){ hidden.value=''; openWith(input.value); });
    input.addEventListener('keydown', function(e){
      var items = Array.from(menu.querySelectorAll('li[role="option"]'));
      if (menu.classList.contains('hidden') && (e.key==='ArrowDown' || e.key==='Enter')) { openWith(input.value); return; }
      if (!items.length) return;
      if (e.key==='ArrowDown'){ e.preventDefault(); activeIndex = Math.min(items.length-1, activeIndex+1); }
      else if (e.key==='ArrowUp'){ e.preventDefault(); activeIndex = Math.max(0, activeIndex-1); }
      else if (e.key==='Enter'){ e.preventDefault(); if (activeIndex>=0) select(items[activeIndex].textContent); else if (items.length) select(items[0].textContent); }
      else if (e.key==='Escape'){ close(); }
      items.forEach(function(li, i){ li.setAttribute('aria-selected', String(i===activeIndex)); });
      if (activeIndex>=0) items[activeIndex].scrollIntoView({ block: 'nearest' });
    });
    document.addEventListener('click', function(e){ if (!box.contains(e.target)) close(); });
    var form = input.closest('form');
    if (form) form.addEventListener('submit', function(){ if (!hidden.value && input.value){ var list = candidates(input.value); if (list.length){ hidden.value = list[0]; input.value = list[0]; } } close(); });
  }

  // Initialize both comboboxes
  initCombo({ boxId:'site-combobox', inputId:'siteSearch', menuId:'siteMenu', hiddenId:'siteValue', dataId:'sites-data' });
  initCombo({ boxId:'habitat-combobox', inputId:'habitatSearch', menuId:'habitatMenu', hiddenId:'habitatValue', dataId:'habitats-data' });

  // Mode-driven visibility (same as plants page)
  (function(){
    var modeSel = document.getElementById('mode');
    var siteBox = document.getElementById('site-combobox');
    var habitatBox = document.getElementById('habitat-combobox');
    function toggle(){
      var m = modeSel.value;
      var bySite = (m === 'by_site');
      var byHabitat = (m === 'by_habitat');
      siteBox.style.display = bySite ? 'block' : 'none';
      habitatBox.style.display = byHabitat ? 'block' : 'none';
      if (bySite){
        var hv = document.getElementById('habitatValue'); var hs = document.getElementById('habitatSearch'); if (hv) hv.value=''; if (hs) hs.value='';
      } else if (byHabitat) {
        var sv = document.getElementById('siteValue'); var ss = document.getElementById('siteSearch'); if (sv) sv.value=''; if (ss) ss.value='';
      }
    }
    modeSel.addEventListener('change', toggle);
    toggle();
  })();
</script>
{% endblock %}
{% endblock %}


