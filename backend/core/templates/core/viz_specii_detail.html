{% extends "base.html" %}
{% block title %}{{ s.denumire_stiintifica }} · ResNat{% endblock %}
{% block content %}
<section class="container">
  <header class="hero">
    <h1>{{ s.denumire_stiintifica }}</h1>
    <p class="muted">{{ s.denumire_populara|default:"—" }}</p>
  </header>

  <div class="card" id="species-card">
    <div class="mb-2" id="species-desc" data-desc="species">
      <strong>Descriere</strong>
      <div class="muted">{{ s.description|default:"" }}</div>
    </div>
    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px;">
      <div>
        <strong>Clasă</strong>
        <div class="muted">{{ s.clasa|default:"—" }}</div>
      </div>
      <div>
        <strong>Familie</strong>
        <div class="muted">{{ s.familia|default:"—" }}</div>
      </div>
      <div>
        <strong>Habitat</strong>
        <div class="muted">{{ s.habitat|default:"—" }}</div>
      </div>
      <div>
        <strong>Localitatea</strong>
        <div class="muted">{{ s.localitatea|default:"—" }}</div>
      </div>
      <div>
        <strong>Silvice</strong>
        <div class="muted">{{ s.silvice|yesno:"Da,Nu" }}</div>
      </div>
      <div>
        <strong>Pajiști/stepice</strong>
        <div class="muted">{{ s.pajisti_sau_stepice|yesno:"Da,Nu" }}</div>
      </div>
      <div>
        <strong>Stâncării</strong>
        <div class="muted">{{ s.stancarii|yesno:"Da,Nu" }}</div>
      </div>
      <div>
        <strong>Palustre/acvatice</strong>
        <div class="muted">{{ s.palustre_si_acvatice|yesno:"Da,Nu" }}</div>
      </div>
      <div>
        <strong>Conventia Berna</strong>
        <div class="muted">{{ s.conventia_berna|yesno:"Da,Nu" }}</div>
      </div>
      <div>
        <strong>Directiva Habitate</strong>
        <div class="muted">{{ s.directiva_habitate|yesno:"Da,Nu" }}</div>
      </div>
      <div>
        <strong>Cartea Roșie (an)</strong>
        <div class="muted">{{ s.cartea_rosie|default:"—" }}</div>
      </div>
      <div>
        <strong>Categoria</strong>
        <div class="muted">{{ s.cartea_rosie_cat|default:"—" }}</div>
      </div>
      <div>
        <strong>Frecvență</strong>
        <div class="muted">{{ s.frecventa|default:"—" }}</div>
      </div>
    </div>

    {% if s.notes %}
    <div class="mt-4">
      <strong>Note</strong>
      <div class="muted">{{ s.notes }}</div>
    </div>
    {% endif %}

    <div class="mt-3" style="display:flex; gap:8px; justify-content:space-between; align-items:center;">
      <a href="{% url 'viz_specii' %}" class="btn btn-outline">Înapoi la specii</a>
      {% if is_admin %}
      <button id="btn-edit-species" class="btn" aria-label="Editează descriere"><span aria-hidden="true">✎</span> Edit</button>
      {% endif %}
    </div>
  </div>
  {% if s.is_rare and points and points|length > 0 %}
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <div id="species-map" style="width:100%; height:520px; margin-top:16px; border-radius:12px; overflow:hidden; box-shadow: var(--shadow);"></div>
  {% endif %}
</section>

{% block extra_js %}
  {% if s.is_rare and points and points|length > 0 %}
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
  <script>
    (function(){
      if (!document.getElementById('species-map')) return;
      var points = {{ points|safe }};
      var mdCenter = [47.0, 28.5];
      var map = L.map('species-map', { center: mdCenter, zoom: 7, scrollWheelZoom: true });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
      var bounds = [];
      points.forEach(function(p){ var m = L.marker([p.lat, p.lon]).addTo(map); if (p.label) { m.bindPopup(p.label); } bounds.push([p.lat, p.lon]); });
      if (bounds.length > 0) { map.fitBounds(bounds, { padding: [30,30], maxZoom: 11 }); }
    })();
  </script>
  {% endif %}
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      var btn = document.getElementById('btn-edit-species');
      if (!btn) return;
      var card = document.getElementById('species-card');
      var desc = document.getElementById('species-desc');

      function autosize(textarea){
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 360) + 'px';
      }
      function toast(msg){
        var t = document.createElement('div');
        t.setAttribute('role','status');
        t.style.position='fixed'; t.style.right='16px'; t.style.bottom='16px'; t.style.background='#0d2214'; t.style.color='#fff'; t.style.padding='10px 14px'; t.style.borderRadius='10px'; t.style.boxShadow='var(--shadow)';
        t.textContent = msg; document.body.appendChild(t); setTimeout(()=>{ t.remove(); }, 1800);
      }

      btn.addEventListener('click', function(){
        var current = {{ s.description|default:""|escapejs }};
        // swap display with editor
        var editor = document.createElement('div');
        editor.innerHTML = '<strong id="desc-label">Descriere</strong>\n<textarea aria-labelledby="desc-label" id="species-textarea" rows="6" style="width:100%; margin-top:6px; padding:10px; line-height:1.5; border:1px solid var(--line); border-radius:10px; outline: 2px solid transparent;" placeholder="Adaugă o descriere…"></textarea>\n<div style="margin-top:8px; display:flex; gap:8px; justify-content:flex-end;">\n  <button type="button" id="cancel-edit" class="btn btn-outline">Cancel</button>\n  <button type="button" id="save-edit" class="btn">Save</button>\n</div>';
        desc.replaceWith(editor);
        var textarea = editor.querySelector('#species-textarea');
        textarea.value = current || '';
        autosize(textarea);
        textarea.addEventListener('input', function(){ autosize(textarea); });
        textarea.focus();

        function getCookie(name){ var m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)'); return m ? m.pop() : ''; }
        function setLoading(on){ var btnSave = editor.querySelector('#save-edit'); btnSave.disabled = !!on; btnSave.textContent = on ? 'Saving…' : 'Save'; textarea.disabled = !!on; }

        editor.addEventListener('keydown', function(e){
          if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') editor.querySelector('#save-edit').click();
          if (e.key === 'Escape') editor.querySelector('#cancel-edit').click();
        });

        editor.querySelector('#cancel-edit').addEventListener('click', function(){ editor.replaceWith(desc); });

        editor.querySelector('#save-edit').addEventListener('click', async function(){
          setLoading(true);
          try {
            var fd = new FormData();
            fd.append('description', textarea.value);
            const resp = await fetch('{% url "update_species_description" s.id %}', { method:'POST', headers:{ 'X-Requested-With':'fetch', 'X-CSRFToken': getCookie('csrftoken') }, body: fd });
            if (!resp.ok) throw new Error('Save failed');
            const data = await resp.json();
            // optimistic update
            desc.querySelector('.muted').textContent = data.description || '';
            editor.replaceWith(desc);
            toast('Salvat');
          } catch(e){ toast('Eroare la salvare'); }
          finally { setLoading(false); }
        });
      });
    });
  </script>
{% endblock %}
{% endblock %}

