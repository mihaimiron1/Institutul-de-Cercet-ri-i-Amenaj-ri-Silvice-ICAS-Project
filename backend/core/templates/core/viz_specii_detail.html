{% extends "base.html" %}
{% block title %}{{ s.denumire_stiintifica }} · ResNat{% endblock %}
{% block content %}
<section class="container">
  <header class="hero">
    <h1>{{ s.denumire_stiintifica }}</h1>
    <p class="muted">{{ s.denumire_populara|default:"—" }}</p>
  </header>

  <div class="card" id="species-card">
    <div class="mb-2" id="species-desc" data-desc="species">
      <strong>Descriere</strong>
      <div class="muted">{{ s.description|default:"" }}</div>
    </div>
    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px;">
      <div>
        <strong>Clasă</strong>
        <div class="muted">{{ s.clasa|default:"—" }}</div>
      </div>
      <div>
        <strong>Familie</strong>
        <div class="muted">{{ s.familia|default:"—" }}</div>
      </div>
      <div>
        <strong>Habitat</strong>
        <div class="muted">{{ s.habitat|default:"—" }}</div>
      </div>
      <div>
        <strong>Localitatea</strong>
        <div class="muted">{{ s.localitatea|default:"—" }}</div>
      </div>
      <div>
        <strong>Silvice</strong>
        <div class="muted">{{ s.silvice|yesno:"Da,Nu" }}</div>
      </div>
      <div>
        <strong>Pajiști/stepice</strong>
        <div class="muted">{{ s.pajisti_sau_stepice|yesno:"Da,Nu" }}</div>
      </div>
      <div>
        <strong>Stâncării</strong>
        <div class="muted">{{ s.stancarii|yesno:"Da,Nu" }}</div>
      </div>
      <div>
        <strong>Palustre/acvatice</strong>
        <div class="muted">{{ s.palustre_si_acvatice|yesno:"Da,Nu" }}</div>
      </div>
      <div>
        <strong>Conventia Berna</strong>
        <div class="muted">{{ s.conventia_berna|yesno:"Da,Nu" }}</div>
      </div>
      <div>
        <strong>Directiva Habitate</strong>
        <div class="muted">{{ s.directiva_habitate|yesno:"Da,Nu" }}</div>
      </div>
      <div>
        <strong>Cartea Roșie (an)</strong>
        <div class="muted">{{ s.cartea_rosie|default:"—" }}</div>
      </div>
      <div>
        <strong>Categoria</strong>
        <div class="muted">{{ s.cartea_rosie_cat|default:"—" }}</div>
      </div>
      <div>
        <strong>Frecvență</strong>
        <div class="muted">{{ s.frecventa|default:"—" }}</div>
      </div>
    </div>

    {% if s.notes %}
    <div class="mt-4">
      <strong>Note</strong>
      <div class="muted">{{ s.notes }}</div>
    </div>
    {% endif %}

    <div class="mt-3" style="display:flex; gap:8px; justify-content:space-between; align-items:center;">
      <a href="{% url 'viz_specii' %}" class="btn btn-outline">Înapoi la specii</a>
      {% if is_admin %}
      <button id="btn-edit-species" class="btn" aria-label="Editează descriere"><span aria-hidden="true">✎</span> Edit</button>
      {% endif %}
    </div>
  </div>
  {% if s.is_rare and points and points|length > 0 %}
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <div id="species-map" style="width:100%; height:520px; margin-top:16px; border-radius:12px; overflow:hidden; box-shadow: var(--shadow);"></div>
  {% endif %}
</section>

{% block extra_js %}
  {% if s.is_rare and points and points|length > 0 %}
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
  {{ points|json_script:"species-points-data" }}
  <script>
    (function(){
      if (!document.getElementById('species-map')) return;
      if (window.__speciesMapInit) return; window.__speciesMapInit = true;
      var points = JSON.parse(document.getElementById('species-points-data').textContent);
      var mdCenter = [47.0, 28.5];
      var map = L.map('species-map', { center: mdCenter, zoom: 7, scrollWheelZoom: true });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
      var bounds = [];
      points.forEach(function(p){ var m = L.marker([p.lat, p.lon]).addTo(map); if (p.label) { m.bindPopup(p.label); } bounds.push([p.lat, p.lon]); });
      if (bounds.length > 0) { map.fitBounds(bounds, { padding: [30,30], maxZoom: 11 }); }
    })();
  </script>
  {% endif %}
  <script>
    (function(){
      var card = document.getElementById('species-card');
      var desc = document.getElementById('species-desc');

      function autosize(textarea){
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 360) + 'px';
      }
      function toast(msg){
        var t = document.createElement('div');
        t.setAttribute('role','status');
        t.style.position='fixed'; t.style.right='16px'; t.style.bottom='16px'; t.style.background='#0d2214'; t.style.color='#fff'; t.style.padding='10px 14px'; t.style.borderRadius='10px'; t.style.boxShadow='var(--shadow)';
        t.textContent = msg; document.body.appendChild(t); setTimeout(()=>{ t.remove(); }, 1800);
      }
      function getCookie(name){ var m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)'); return m ? m.pop() : ''; }
      function buildGuardModal(){
        var wrap = document.createElement('div');
        wrap.id='unsaved-guard';
        wrap.innerHTML = '<div style="position:fixed; inset:0; background:rgba(0,0,0,.28); display:flex; align-items:center; justify-content:center; z-index:9999;">\n  <div role="dialog" aria-modal="true" style="background:#fff; color:var(--text); max-width:520px; width:92%; border-radius:12px; box-shadow:var(--shadow); padding:16px;">\n    <h3 style="margin:0 0 8px; font-size:1.1rem;">You have unsaved changes</h3>\n    <p class="muted" style="margin:0 0 12px;">Save before leaving?</p>\n    <div style="display:flex; gap:8px; justify-content:flex-end;">\n      <button type="button" id="guard-stay" class="btn btn-outline">Stay</button>\n      <button type="button" id="guard-discard" class="btn btn-outline">Discard</button>\n      <button type="button" id="guard-save" class="btn">Save and leave</button>\n    </div>\n  </div>\n</div>';
        return wrap;
      }

      document.addEventListener('click', function(ev){
        var btn = ev.target.closest('#btn-edit-species');
        if (!btn) return;
        var current = "{{ s.description|default:''|escapejs }}";
        // swap display with editor
        var editor = document.createElement('div');
        editor.innerHTML = '<strong id="desc-label">Descriere</strong>\n<textarea aria-labelledby="desc-label" id="species-textarea" rows="6" style="width:100%; margin-top:6px; padding:10px; line-height:1.5; border:1px solid var(--line); border-radius:10px; outline: 2px solid transparent;" placeholder="Adaugă o descriere…"></textarea>\n<div style="margin-top:8px; display:flex; gap:8px; justify-content:flex-end;">\n  <button type="button" id="cancel-edit" class="btn btn-outline">Cancel</button>\n  <button type="button" id="save-edit" class="btn" disabled>Save</button>\n</div>';
        desc.replaceWith(editor);
        var textarea = editor.querySelector('#species-textarea');
        textarea.value = current || '';
        autosize(textarea);
        textarea.addEventListener('input', function(){ autosize(textarea); });
        textarea.focus();

        var btnSave = editor.querySelector('#save-edit');
        var dirty = false;
        function setLoading(on){ btnSave.disabled = !!on; btnSave.textContent = on ? 'Saving…' : 'Save'; textarea.disabled = !!on; }
        function setDisabledState(){
          var trimmed = (textarea.value || '').replace(/\s+$/,'');
          btnSave.disabled = (trimmed === (current || '')) || trimmed.length === 0;
        }
        setDisabledState();
        textarea.addEventListener('input', function(){ dirty = (textarea.value !== (current || '')); setDisabledState(); });

        editor.addEventListener('keydown', function(e){
          if ((e.ctrlKey || e.metaKey) && e.key === 'Enter' && !btnSave.disabled) btnSave.click();
          if (e.key === 'Escape') editor.querySelector('#cancel-edit').click();
        });

        // Unsaved changes guard for navigation
        var guardActive = false, pendingNavHref=null;
        function beforeUnload(e){ if (dirty){ e.preventDefault(); e.returnValue=''; } }
        window.addEventListener('beforeunload', beforeUnload);
        document.addEventListener('click', function(e){
          var a = e.target.closest('a');
          if (!a || !dirty) return;
          e.preventDefault();
          var modal = buildGuardModal(); document.body.appendChild(modal);
          modal.querySelector('#guard-stay').focus();
          modal.querySelector('#guard-stay').onclick = function(){ modal.remove(); };
          modal.querySelector('#guard-discard').onclick = function(){ window.removeEventListener('beforeunload', beforeUnload); window.location.href = a.href; };
          modal.querySelector('#guard-save').onclick = async function(){ await doSave(true, a.href); };
        }, true);

        editor.querySelector('#cancel-edit').addEventListener('click', function(){ window.removeEventListener('beforeunload', beforeUnload); editor.replaceWith(desc); });

        async function doSave(navigateAfter, href){
          setLoading(true);
          try {
            var fd = new FormData(); fd.append('description', (textarea.value || '').replace(/\s+$/,''));
            const resp = await fetch('{% url "update_species_description" s.id %}', { method:'POST', headers:{ 'X-Requested-With':'fetch', 'X-CSRFToken': getCookie('csrftoken') }, body: fd });
            if (!resp.ok) throw new Error('Save failed');
            const data = await resp.json();
            desc.querySelector('.muted').textContent = data.description || '';
            editor.replaceWith(desc);
            window.removeEventListener('beforeunload', beforeUnload);
            toast('Saved');
            if (navigateAfter && href) window.location.href = href;
          } catch(e){ toast('Save error'); }
          finally { setLoading(false); }
        }

        btnSave.addEventListener('click', function(){ if (!btnSave.disabled) doSave(false); });
      }, true);
    })();
  </script>
{% endblock %}
{% endblock %}

