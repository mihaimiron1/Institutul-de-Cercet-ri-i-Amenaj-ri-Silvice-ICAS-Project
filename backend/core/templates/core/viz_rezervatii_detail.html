{% extends "base.html" %}
{% block title %}{{ r.name }} · ResNat{% endblock %}
{% block content %}
<section class="container">
  <header class="hero">
    <h1>{{ r.name }}</h1>
    <p class="muted">{{ r.category|default:"—" }}{% if r.subcategory %} · {{ r.subcategory }}{% endif %}</p>
  </header>

  <div class="card" id="reserve-card">
    <div class="mb-2" id="reserve-desc" data-desc="reserve">
      <strong>Descriere</strong>
      <div class="muted">{{ r.description|default:"" }}</div>
    </div>
    <div class="grid" id="reserve-meta" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px 16px;">
      <div data-span="2" style="grid-column: span 2;">
        <strong>Nume</strong>
        <div class="muted" data-f="name">{{ r.name }}</div>
      </div>
      <div>
        <strong>Raion</strong>
        <div class="muted" data-f="raion">{{ r.raion|default:"—" }}</div>
      </div>
      <div data-span="2" style="grid-column: span 2;">
        <strong>Amplasare</strong>
        <div class="muted" data-f="amplasare">{{ r.amplasare|default:"—" }}</div>
      </div>
      <div data-span="2" style="grid-column: span 2;">
        <strong>Proprietar</strong>
        <div class="muted" data-f="proprietar">{{ r.proprietar|default:"—" }}</div>
      </div>
      <div>
        <strong>Suprafață (ha)</strong>
        <div class="muted" data-f="suprafata_ha">{{ r.suprafata_ha|default:"—" }}</div>
      </div>
      <div data-span="2" style="grid-column: span 2;">
        <strong>Categoria</strong>
        <div class="muted" data-f="category">{{ r.category|default:"—" }}</div>
      </div>
      <div data-span="2" style="grid-column: span 2;">
        <strong>Subcategoria</strong>
        <div class="muted" data-f="subcategory">{{ r.subcategory|default:"—" }}</div>
      </div>
      <div>
        <strong>Coordonate</strong>
        <div class="muted" data-f="coords">{% if r.latitude and r.longitude %}{{ r.latitude }}, {{ r.longitude }}{% else %}—{% endif %}</div>
      </div>
    </div>

    {% if r.diversitatea_fitocenotica %}
    <div class="mt-4">
      <strong>Diversitatea fitocenotică</strong>
      <div class="muted">{{ r.diversitatea_fitocenotica }}</div>
    </div>
    {% endif %}

    {% if r.notes %}
    <div class="mt-4">
      <strong>Note</strong>
      <div class="muted">{{ r.notes }}</div>
    </div>
    {% endif %}

    <div class="mt-3" style="display:flex; gap:8px; justify-content:space-between; align-items:center;">
      <a href="{% url 'viz_rez' %}" class="btn btn-outline">Înapoi la rezervații</a>
      {% if is_admin %}
      <button id="actionBtn" class="btn" aria-label="Editează metadate"><span aria-hidden="true">✎</span> Edit</button>
      {% endif %}
    </div>
  </div>

  {% if r.latitude and r.longitude %}
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <div id="reserve-map" style="width:100%; height:520px; margin-top:16px; border-radius:12px; overflow:hidden; box-shadow: var(--shadow);"></div>
  {% endif %}
</section>
{% endblock %}

{% block extra_css %}
<style>
  /* Card expansion and responsive grid */
  #reserve-card {
    transition: height 120ms ease;
  }
  
  /* Responsive grid - long fields span 2 columns on larger screens */
  @media (min-width: 768px) {
    #reserve-meta[data-edit-mode="true"] {
      grid-template-columns: repeat(4, 1fr);
    }
    #reserve-meta[data-edit-mode="true"] [data-span="2"] {
      grid-column: span 2;
    }
  }
  
  /* Allow very long fields to span full row if needed */
  #reserve-meta[data-edit-mode="true"] .span-full-row {
    grid-column: 1 / -1;
  }
  
  /* Ensure inputs are full width and properly styled */
  #reserve-meta input,
  #reserve-meta textarea {
    width: 100% !important;
    box-sizing: border-box;
    min-width: 0; /* Allow flex items to shrink below content size */
  }
  
  /* Ensure grid items don't overflow */
  #reserve-meta > div {
    min-width: 0;
    overflow: hidden;
    max-width: 100%;
    word-wrap: break-word;
    word-break: break-all;
  }
  
  /* Smooth transitions for input height changes */
  #reserve-meta textarea {
    transition: height 120ms ease;
    word-break: break-word;
    white-space: pre-wrap;
    overflow-wrap: anywhere;
    hyphens: auto;
  }
  
  /* Ensure long text wraps properly in both view and edit modes */
  #reserve-meta .muted {
    white-space: normal;
    overflow-wrap: anywhere;
    word-break: break-word;
    hyphens: auto;
    max-width: 100%;
    overflow: hidden;
  }
  
  /* Prevent horizontal overflow in the grid */
  #reserve-meta {
    overflow: hidden;
  }
  
  /* Ensure textareas don't cause horizontal overflow */
  #reserve-meta textarea {
    max-width: 100%;
    overflow-x: hidden;
    overflow-y: hidden;
  }
  
  /* Force text wrapping for very long strings */
  #reserve-meta .muted,
  #reserve-meta textarea {
    word-break: break-all;
    overflow-wrap: break-word;
  }
  
  /* Ensure grid items respect column boundaries */
  #reserve-meta > div {
    max-width: 100%;
    word-wrap: break-word;
  }
</style>
{% endblock %}

{% block extra_js %}
  {% if r.latitude and r.longitude %}
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    (function(){
      if (!document.getElementById('reserve-map')) return;
      if (window.__reserveMapInit) return; window.__reserveMapInit = true;
      var lat = {{ r.latitude|floatformat:"6" }};
      var lon = {{ r.longitude|floatformat:"6" }};
      var mdCenter = [47.0, 28.5];
      var map = L.map('reserve-map', { center: [lat, lon] || mdCenter, zoom: 8, scrollWheelZoom: true });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
      var marker = L.marker([lat, lon]).addTo(map); marker.bindPopup(`{{ r.name|escapejs }}`); map.setView([lat, lon], 10);
    })();
  </script>
  {% endif %}
  <script>
    (function(){
      var card = document.getElementById('reserve-card');
      var meta = document.getElementById('reserve-meta');
      var btn = document.getElementById('actionBtn');

      function toast(msg){ var t=document.createElement('div'); t.setAttribute('role','status'); t.style.position='fixed'; t.style.right='16px'; t.style.bottom='16px'; t.style.background='#0d2214'; t.style.color='#fff'; t.style.padding='10px 14px'; t.style.borderRadius='10px'; t.style.boxShadow='var(--shadow)'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),1800); }
      function getCookie(name){ var m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return m?m.pop():''; }
      function buildGuardModal(){ var wrap=document.createElement('div'); wrap.id='unsaved-guard'; wrap.innerHTML='<div style="position:fixed; inset:0; background:rgba(0,0,0,.28); display:flex; align-items:center; justify-content:center; z-index:9999;">\n  <div role="dialog" aria-modal="true" style="background:#fff; color:var(--text); max-width:520px; width:92%; border-radius:12px; box-shadow:var(--shadow); padding:16px;">\n    <h3 style="margin:0 0 8px; font-size:1.1rem;">You have unsaved changes</h3>\n    <p class=\"muted\" style=\"margin:0 0 12px;\">Save before leaving?</p>\n    <div style=\"display:flex; gap:8px; justify-content:flex-end;\">\n      <button type=\"button\" id=\"guard-stay\" class=\"btn btn-outline\">Stay</button>\n      <button type=\"button\" id=\"guard-discard\" class=\"btn btn-outline\">Discard</button>\n      <button type=\"button\" id=\"guard-save\" class=\"btn\">Save and leave</button>\n    </div>\n  </div>\n</div>'; return wrap; }

      // Global state
      var mode = 'VIEW'; // VIEW | EDITING | SAVING
      var originalValues = {}; // raw originals for UI restore
      var initialValues = {};  // immutable snapshot for dirty checks
      var inputs = {};
      var dirty = false;
      var beforeUnloadHandler = null;
      var internalNavHandler = null;
      var keydownHandler = null;

      // Normalize history to a clean VIEW state on load
      try { history.replaceState({}, '', location.href); } catch(_) {}
      window.addEventListener('popstate', function(){
        // Always force view mode if any edit state lingered
        meta.removeAttribute('data-edit-mode');
        mode = 'VIEW';
      });

      // Single click handler that branches by mode
      btn.addEventListener('click', function(ev) {
        ev.preventDefault();
        if (mode === 'VIEW') {
          enterEdit();
        } else if (mode === 'EDITING') {
          doSave();
        }
        // SAVING mode: button is disabled, no action
      });

        // Convert metadata fields to inputs
        function createInput(field, type, placeholder) {
          var el = meta.querySelector('[data-f="' + field + '"]');
          var val = (el.textContent.trim() === '—') ? '' : el.textContent.trim();
          originalValues[field] = val;
          
          var input;
          if (type === 'text') {
            // Use textarea for text fields with autosizing
            input = document.createElement('textarea');
            input.rows = 1;
            input.style.cssText = 'width:100%; padding:8px; border:1px solid var(--line); border-radius:8px; font-family:inherit; font-size:inherit; resize:none; overflow:hidden; line-height:1.5; transition:height 120ms ease; word-break:break-all; white-space:pre-wrap; overflow-wrap:break-word; hyphens:auto; max-width:100%; overflow-x:hidden; overflow-y:hidden; word-wrap:break-word;';
            autosize(input);
          } else {
            // Use input for numeric fields
            input = document.createElement('input');
            input.type = type;
            input.style.cssText = 'width:100%; padding:8px; border:1px solid var(--line); border-radius:8px; font-family:inherit; font-size:inherit;';
          }
          
          input.name = field;
          input.placeholder = placeholder || '';
          input.value = val;
          
          el.replaceWith(input);
          inputs[field] = input;
          
          input.addEventListener('input', function(){ 
            computeDirty();
            updateSaveButton();
            if (type === 'text') autosize(input);
          });
        }

        // Autosize function for textareas - no max height, show all content
        function autosize(textarea) {
          textarea.style.height = 'auto';
          var scrollHeight = textarea.scrollHeight;
          var lineHeight = parseFloat(getComputedStyle(textarea).lineHeight);
          var minHeight = lineHeight; // Start at 1 line
          textarea.style.height = Math.max(scrollHeight, minHeight) + 'px';
          
          // If textarea is very tall, make it span full row
          var parentDiv = textarea.closest('[data-span="2"]');
          if (parentDiv && scrollHeight > 200) {
            parentDiv.classList.add('span-full-row');
          } else if (parentDiv) {
            parentDiv.classList.remove('span-full-row');
          }
        }

        // Special handling for coordinates
        function createCoordInputs() {
          var coordsEl = meta.querySelector('[data-f="coords"]');
          var coordsWrap = document.createElement('div');
          coordsWrap.style.cssText = 'display:grid; grid-template-columns:1fr 1fr; gap:6px;';
          
          var lat = document.createElement('input');
          lat.type = 'number';
          lat.name = 'latitude';
          lat.placeholder = 'Lat (-90..90)';
          lat.step = '0.000001';
          lat.min = '-90';
          lat.max = '90';
          
          var lon = document.createElement('input');
          lon.type = 'number';
          lon.name = 'longitude';
          lon.placeholder = 'Lon (-180..180)';
          lon.step = '0.000001';
          lon.min = '-180';
          lon.max = '180';
          
          lat.style.cssText = lon.style.cssText = 'width:100%; padding:8px; border:1px solid var(--line); border-radius:8px; font-family:inherit; font-size:inherit;';
          
          var parts = coordsEl.textContent.split(',');
          var latVal = (parts[0]||'').trim() === '—' ? '' : (parts[0]||'').trim();
          var lonVal = (parts[1]||'').trim() === '—' ? '' : (parts[1]||'').trim();
          
          lat.value = latVal;
          lon.value = lonVal;
          originalValues.latitude = latVal;
          originalValues.longitude = lonVal;
          
          coordsWrap.appendChild(lat);
          coordsWrap.appendChild(lon);
          coordsEl.replaceWith(coordsWrap);
          
          inputs.latitude = lat;
          inputs.longitude = lon;
          
          lat.addEventListener('input', function(){ computeDirty(); updateSaveButton(); });
          lon.addEventListener('input', function(){ computeDirty(); updateSaveButton(); });
        }

        function setLoading(on) {
        btn.disabled = !!on;
        btn.innerHTML = on ? 'Saving…' : 'Save';
          Object.values(inputs).forEach(function(input) { input.disabled = !!on; });
        }

        // Normalization helper for comparisons
        function normalizeText(value){
          if (value == null) return '';
          var s = String(value);
          s = s.replace(/\r\n?|\u2028|\u2029/g, '\n');
          s = s.split('\n').map(function(line){ return line.replace(/\s+/g, ' ').trim(); }).join('\n');
          return s.trim();
        }

        function snapshotInitialValues(){
          initialValues = {};
          for (var field in inputs){
            initialValues[field] = normalizeText(inputs[field].value || '');
          }
        }

        function computeDirty(){
          var wasDirty = dirty;
          dirty = false;
          for (var field in inputs){
            var curr = normalizeText(inputs[field].value || '');
            if (curr !== (initialValues[field] || '')){ dirty = true; break; }
          }
          if (dirty !== wasDirty) updateGuards();
        }

        function updateSaveButton(){
          // Keep Save enabled in EDITING regardless of dirty; only disable if not in EDITING
        btn.disabled = mode !== 'EDITING';
      }

      // Enter edit mode
      function enterEdit() {
        mode = 'EDITING';
        
        // Set edit mode attribute for CSS
        meta.setAttribute('data-edit-mode', 'true');
        
        // Create all inputs
        createInput('name', 'text', 'Nume');
        createInput('raion', 'text', 'Raion');
        createInput('amplasare', 'text', 'Amplasare');
        createInput('proprietar', 'text', 'Proprietar');
        createInput('suprafata_ha', 'number', 'Suprafață (ha)');
        createInput('category', 'text', 'Categoria');
        createInput('subcategory', 'text', 'Subcategoria');
        createCoordInputs();

        // Toggle the same button to Save mode
        btn.innerHTML = 'Save';
        btn.setAttribute('aria-label', 'Salvează modificările');

        // Focus first input
        inputs.name.focus();
        
        // Ensure all textareas expand to fit content immediately after render
        requestAnimationFrame(function() {
          Object.values(inputs).forEach(function(input) {
            if (input.tagName === 'TEXTAREA') {
              autosize(input);
            }
          });
        });

        // Snapshot and initialize guards
        snapshotInitialValues();
        computeDirty();
        updateSaveButton();
        updateGuards();

        // Keyboard shortcuts
        keydownHandler = function(e) {
          if ((e.ctrlKey || e.metaKey) && e.key === 'Enter' && !btn.disabled) {
            btn.click();
          }
          if (e.key === 'Escape') {
            cancelEdit();
          }
        };
        document.addEventListener('keydown', keydownHandler);
      }

      // Cancel edit mode
      function cancelEdit() {
          detachBeforeUnload();
          detachInternalNavGuard();
          if (keydownHandler) { document.removeEventListener('keydown', keydownHandler); keydownHandler = null; }
          // Remove edit mode attribute
          meta.removeAttribute('data-edit-mode');
          // Restore original display for regular fields
          for (var field in inputs) {
            if (field === 'latitude' || field === 'longitude') continue; // Handle coords separately
            var display = document.createElement('div');
            display.className = 'muted';
            display.setAttribute('data-f', field);
            display.textContent = (originalValues[field] || '') === '' ? '—' : originalValues[field];
            inputs[field].replaceWith(display);
          }
          // Restore coordinates display
          var coordsDisplay = document.createElement('div');
          coordsDisplay.className = 'muted';
          coordsDisplay.setAttribute('data-f', 'coords');
          if (originalValues.latitude && originalValues.longitude) {
            coordsDisplay.textContent = originalValues.latitude + ', ' + originalValues.longitude;
          } else {
            coordsDisplay.textContent = '—';
          }
          inputs.latitude.parentNode.replaceWith(coordsDisplay);
          // Restore Edit button
        btn.innerHTML = '<span aria-hidden="true">✎</span> Edit';
        btn.setAttribute('aria-label', 'Editează metadate');
          // Clean state
        mode = 'VIEW';
        dirty = false;
        try { history.replaceState({}, '', location.href); } catch(_) {}
      }

      // Save function
      async function doSave() {
        // Recompute dirty at click time
        computeDirty();

        // No-op save if nothing changed
        if (!dirty) {
          // Restore original display for regular fields
          for (var field in inputs) {
            if (field === 'latitude' || field === 'longitude') continue; // Handle coords separately
            var display = document.createElement('div');
            display.className = 'muted';
            display.setAttribute('data-f', field);
            var currentVal = inputs[field].value.trim();
            display.textContent = currentVal === '' ? '—' : currentVal;
            inputs[field].replaceWith(display);
          }
          // Restore coordinates display
          var coordsDisplay = document.createElement('div');
          coordsDisplay.className = 'muted';
          coordsDisplay.setAttribute('data-f', 'coords');
          if (inputs.latitude && inputs.longitude) {
            var latVal = inputs.latitude.value.trim();
            var lonVal = inputs.longitude.value.trim();
            if (latVal && lonVal) {
              coordsDisplay.textContent = latVal + ', ' + lonVal;
            } else {
              coordsDisplay.textContent = '—';
            }
          } else {
            coordsDisplay.textContent = '—';
          }
          if (inputs.latitude && inputs.latitude.parentNode) {
            inputs.latitude.parentNode.replaceWith(coordsDisplay);
          }
          
          // Restore Edit button
          btn.innerHTML = '<span aria-hidden="true">✎</span> Edit';
          btn.setAttribute('aria-label', 'Editează metadate');
          mode = 'VIEW';
          dirty = false;
          try { history.replaceState({}, '', location.href); } catch(_) {}
          return;
        }

        mode = 'SAVING';
        setLoading(true);
        try {
          var formData = new FormData();
          formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
          
          // Only send changed fields
          for (var field in inputs) {
            var currentVal = inputs[field].value.trim();
            var originalVal = originalValues[field] || '';
            if (currentVal !== originalVal) {
              formData.append(field, currentVal);
            }
          }

          var response = await fetch('{% url "update_reserve_meta" r.pk %}', {
            method: 'POST',
            body: formData,
            headers: {
              'X-CSRFToken': getCookie('csrftoken')
            }
          });

          if (!response.ok) {
            var errorData = await response.json().catch(function() { return { error: 'Network error' }; });
            throw new Error(errorData.error || 'Save failed');
          }

          var data = await response.json();
          if (!data.ok) {
            throw new Error(data.error || 'Save failed');
          }

          // Update originalValues with current values
          for (var field in inputs) {
            originalValues[field] = inputs[field].value.trim();
          }

          // Restore original display for regular fields
          for (var field in inputs) {
            if (field === 'latitude' || field === 'longitude') continue; // Handle coords separately
            var display = document.createElement('div');
            display.className = 'muted';
            display.setAttribute('data-f', field);
            var currentVal = inputs[field].value.trim();
            display.textContent = currentVal === '' ? '—' : currentVal;
            inputs[field].replaceWith(display);
          }
          // Restore coordinates display
          var coordsDisplay = document.createElement('div');
          coordsDisplay.className = 'muted';
          coordsDisplay.setAttribute('data-f', 'coords');
          if (inputs.latitude && inputs.longitude) {
            var latVal = inputs.latitude.value.trim();
            var lonVal = inputs.longitude.value.trim();
            if (latVal && lonVal) {
              coordsDisplay.textContent = latVal + ', ' + lonVal;
            } else {
              coordsDisplay.textContent = '—';
            }
          } else {
            coordsDisplay.textContent = '—';
          }
          if (inputs.latitude && inputs.latitude.parentNode) {
            inputs.latitude.parentNode.replaceWith(coordsDisplay);
          }
          
          // Restore Edit button
          btn.innerHTML = '<span aria-hidden="true">✎</span> Edit';
          btn.setAttribute('aria-label', 'Editează metadate');
          // Refresh snapshot and state
          snapshotInitialValues();
          dirty = false;
          mode = 'VIEW';
          updateGuards();
          try { history.replaceState({}, '', location.href); } catch(_) {}
        } catch (e) {
          toast('Save error: ' + e.message);
        } finally {
          setLoading(false);
          if (mode === 'SAVING') { mode = 'EDITING'; updateGuards(); }
        }
      }

      // Guards attach/detach
      function attachBeforeUnload(){
        if (beforeUnloadHandler) return;
        beforeUnloadHandler = function(e){
          if (dirty && mode === 'EDITING'){
            e.preventDefault();
            e.returnValue = '';
            return '';
          }
        };
        window.addEventListener('beforeunload', beforeUnloadHandler);
      }

      function detachBeforeUnload(){
        if (beforeUnloadHandler) {
          window.removeEventListener('beforeunload', beforeUnloadHandler);
          beforeUnloadHandler = null;
        }
      }

      function attachInternalNavGuard(){
        if (internalNavHandler) return;
        internalNavHandler = function(ev){
          var link = ev.target.closest('a[href]');
          if (!link) return;
          if (dirty && mode === 'EDITING'){
            ev.preventDefault();
            var modal = buildGuardModal();
            document.body.appendChild(modal);
            var guardStay = modal.querySelector('#guard-stay');
            var guardDiscard = modal.querySelector('#guard-discard');
            var guardSave = modal.querySelector('#guard-save');
            guardStay.addEventListener('click', function(){
              modal.remove();
            });
            guardDiscard.addEventListener('click', function(){
              modal.remove();
              window.location.href = link.href;
            });
            guardSave.addEventListener('click', function(){
              modal.remove();
              doSave(true, link.href);
            });
          }
        };
        document.addEventListener('click', internalNavHandler, true);
      }

      function detachInternalNavGuard(){
        if (internalNavHandler) {
          document.removeEventListener('click', internalNavHandler, true);
          internalNavHandler = null;
        }
      }

      function updateGuards(){
        if (dirty && mode === 'EDITING') { attachBeforeUnload(); attachInternalNavGuard(); }
        else { detachBeforeUnload(); detachInternalNavGuard(); }
      }
    })();
  </script>
{% endblock %}

