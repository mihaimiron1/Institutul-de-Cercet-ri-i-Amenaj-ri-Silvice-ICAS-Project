{% extends "base.html" %}
{% block title %}Filtre · Asociații{% endblock %}
{% block content %}
<section id="asociatii-filters" class="container">
  <header class="hero">
    <h1>Asociații</h1>
    <p class="muted">Rezervație ↔ Asociație, cu aceleași filtre și export ca la Plante.</p>
  </header>

  <div class="card filters-panel">
    <form method="get" class="filters-row">
      <label class="fullw" style="display:flex; flex-direction:column; gap:6px;">
        <span>Mod</span>
        <select name="mode" id="mode" class="form-select fullw">
          <option value="by_reserve_year" {% if mode == 'by_reserve_year' %}selected{% endif %}>Rezervație X în anul Y</option>
          <option value="by_reserve_all_years" {% if mode == 'by_reserve_all_years' %}selected{% endif %}>Rezervație X în toți anii</option>
          <option value="by_year_all_reserves" {% if mode == 'by_year_all_reserves' %}selected{% endif %}>Toate rezervațiile în anul Y</option>
        </select>
      </label>

      <div class="fullw" id="reserve-combobox" style="position:relative; display:none;">
        <label class="label" for="reserveSearch">Rezervație</label>
        <input id="reserveSearch" class="form-control fullw" type="text" inputmode="search" placeholder="Caută rezervație…" autocomplete="off" aria-haspopup="listbox" aria-expanded="false" aria-controls="reserveMenu" aria-autocomplete="list" value="{{ reserve_name|default_if_none:'' }}" />
        <input type="hidden" name="reserve_name" id="reserveValue" value="{{ reserve_name|default_if_none:'' }}" />
        <ul id="reserveMenu" class="combo-menu hidden" role="listbox" tabindex="-1" aria-label="Sugestii rezervație"></ul>
        <script id="reserves-data" type="application/json">{% autoescape off %}[{% for r in all_reserves %}"{{ r.name|escapejs }}"{% if not forloop.last %},{% endif %}{% endfor %}]{% endautoescape %}</script>
      </div>

      <label id="yearLbl" class="fullw" style="display:flex; flex-direction:column; gap:6px;">
        <span>An</span>
        <input type="text" name="year" id="yearInput" value="{{ year_q|default_if_none:'' }}" class="form-control fullw" placeholder="YYYY" maxlength="4" pattern="[0-9]{4}">
        <small id="yearError" class="muted" style="display:none; color:#b00;">Anul trebuie să aibă 4 cifre</small>
      </label>

      <div class="filters-actions">
        <button type="submit" class="btn">Caută</button>
      </div>
    </form>
  </div>

  <div class="prw-results" style="margin-top: 10px; display:flex; align-items:center; justify-content:center; gap:10px;">
    <a class="btn btn-outline" href="{% url 'export_asociatii' %}?{{ request.GET.urlencode }}&format=csv">Export CSV</a>
    <a class="btn btn-outline" href="{% url 'export_asociatii' %}?{{ request.GET.urlencode }}&format=xlsx">Export Excel</a>
  </div>

  {% if error %}
    <div class="muted prw-results mt-4">{{ error }}</div>
  {% endif %}

  <div class="card mt-4 prw-results">
    <div style="overflow:auto;">
      <table style="border-collapse:collapse; width:100%;">
        <thead>
          <tr>
            <th>Rezervație</th>
            <th>Asociație</th>
            <th>An</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
          <tr>
            <td>{{ r.reserve }}</td>
            <td>{{ r.association }}</td>
            <td>{{ r.year }}</td>
            <td>{{ r.notes }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="4">Niciun rezultat.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

{% block extra_js %}
<script>
  function initCombo(opts){
    var box=document.getElementById(opts.boxId); if(!box) return;
    var input=document.getElementById(opts.inputId), menu=document.getElementById(opts.menuId), hidden=document.getElementById(opts.hiddenId), dataEl=document.getElementById(opts.dataId);
    var raw=(dataEl && dataEl.textContent||'[]').trim(); var ITEMS=[]; try{ITEMS=JSON.parse(raw).filter(Boolean);}catch(e){ITEMS=[];}
    function norm(s){return (s||'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().trim();}
    function candidates(q){ if(!q) return ITEMS.slice(0,20); var n=norm(q); return ITEMS.filter(function(name){return norm(name).indexOf(n)!==-1;}).slice(0,20);} 
    var activeIndex=-1;
    function render(list){ while(menu.firstChild) menu.removeChild(menu.firstChild); if(!input.value && list.length===0){ var li0=document.createElement('li'); li0.textContent='— alege —'; li0.setAttribute('aria-disabled','true'); menu.appendChild(li0);} list.forEach(function(name,i){ var li=document.createElement('li'); li.setAttribute('role','option'); li.id=opts.menuId+'-opt-'+i; li.textContent=name; li.addEventListener('mousedown', function(e){e.preventDefault(); select(name);}); menu.appendChild(li); }); input.setAttribute('aria-expanded', String(list.length>0)); menu.classList.toggle('hidden', list.length===0 && !!input.value); activeIndex=-1; }
    function select(name){ input.value=name; hidden.value=name; close(); }
    function close(){ menu.classList.add('hidden'); input.setAttribute('aria-expanded','false'); activeIndex=-1; }
    function openWith(q){ render(candidates(q)); menu.classList.remove('hidden'); }
    input.addEventListener('focus', function(){ openWith(input.value); }); input.addEventListener('input', function(){ hidden.value=''; openWith(input.value); });
    input.addEventListener('keydown', function(e){ var items=Array.from(menu.querySelectorAll('li[role="option"]')); if(menu.classList.contains('hidden') && (e.key==='ArrowDown'||e.key==='Enter')){ openWith(input.value); return;} if(!items.length) return; if(e.key==='ArrowDown'){ e.preventDefault(); activeIndex=Math.min(items.length-1, activeIndex+1);} else if(e.key==='ArrowUp'){ e.preventDefault(); activeIndex=Math.max(0, activeIndex-1);} else if(e.key==='Enter'){ e.preventDefault(); if(activeIndex>=0) select(items[activeIndex].textContent); else if(items.length) select(items[0].textContent);} else if(e.key==='Escape'){ close(); } items.forEach(function(li,i){ li.setAttribute('aria-selected', String(i===activeIndex)); }); if(activeIndex>=0) items[activeIndex].scrollIntoView({block:'nearest'}); });
    document.addEventListener('click', function(e){ if(!box.contains(e.target)) close(); }); var form=input.closest('form'); if(form) form.addEventListener('submit', function(){ if(!hidden.value && input.value){ var list=candidates(input.value); if(list.length){ hidden.value=list[0]; input.value=list[0]; } } close(); });
  }
  initCombo({ boxId:'reserve-combobox', inputId:'reserveSearch', menuId:'reserveMenu', hiddenId:'reserveValue', dataId:'reserves-data' });

  // Year input validation (4 digits only)
  (function(){
    var yearInput = document.getElementById('yearInput');
    var yearError = document.getElementById('yearError');
    function validateYear(){
      var val = yearInput.value.trim();
      if (val && (!/^\d{4}$/.test(val) || parseInt(val) < 1900 || parseInt(val) > 2099)) {
        yearError.style.display = 'block';
        yearInput.style.borderColor = '#b00';
      } else {
        yearError.style.display = 'none';
        yearInput.style.borderColor = '';
      }
    }
    yearInput.addEventListener('input', function(e){
      e.target.value = e.target.value.replace(/[^0-9]/g, '').slice(0, 4);
    });
    yearInput.addEventListener('blur', validateYear);
  })();

  // Mode-driven visibility (same as plants)
  (function(){ 
    var modeSel=document.getElementById('mode'), reserveBox=document.getElementById('reserve-combobox'), yearLbl=document.getElementById('yearLbl');
    var filtersRow = document.querySelector('.filters-row');
    function refresh(){ 
      var m=modeSel.value, needReserve=(m==='by_reserve_year'||m==='by_reserve_all_years'), needYear=(m==='by_reserve_year'||m==='by_year_all_reserves'); 
      reserveBox.style.display=needReserve?'block':'none'; 
      yearLbl.style.display=needYear?'block':'none'; 
      
      // Add compact-layout class when both Reserve and Year are visible
      if(needReserve && needYear) {
        filtersRow.classList.add('compact-layout');
      } else {
        filtersRow.classList.remove('compact-layout');
      }
      
      if(!needReserve){ var hv=document.getElementById('reserveValue'), hs=document.getElementById('reserveSearch'); if(hv) hv.value=''; if(hs) hs.value=''; } 
      if(!needYear){ var y=document.getElementById('yearInput'); if(y) y.value=''; } 
    } 
    modeSel.addEventListener('change', refresh); 
    refresh(); 
  })();
</script>
{% endblock %}
{% endblock %}


