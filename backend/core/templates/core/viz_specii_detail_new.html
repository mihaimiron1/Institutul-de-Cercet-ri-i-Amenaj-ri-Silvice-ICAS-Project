{% extends "base.html" %}
{% block title %}{{ s.denumire_stiintifica }} ¬∑ ResNat{% endblock %}
{% block content %}
<section class="container">
  <header class="hero">
    <h1>{{ s.denumire_stiintifica }}</h1>
    <p class="muted">{{ s.denumire_populara|default:"‚Äî" }}</p>
  </header>

  <div class="card" id="species-card">
    <div class="mb-2" id="species-desc" data-desc="species">
      <strong>Descriere</strong>
      <div class="muted">{{ s.description|default:"" }}</div>
    </div>
    <div class="grid" id="species-meta" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px;">
      <div>
        <strong>Nume popular</strong>
        <div class="muted" data-f="denumire_populara">{{ s.denumire_populara|default:"‚Äî" }}</div>
      </div>
      <div>
        <strong>ClasƒÉ</strong>
        <div class="muted" data-f="clasa">{{ s.clasa|default:"‚Äî" }}</div>
      </div>
      <div>
        <strong>Familie</strong>
        <div class="muted" data-f="familia">{{ s.familia|default:"‚Äî" }}</div>
      </div>
      <div>
        <strong>Habitat</strong>
        <div class="muted" data-f="habitat">{{ s.habitat|default:"‚Äî" }}</div>
      </div>
      <div>
        <strong>Localitatea</strong>
        <div class="muted" data-f="localitatea">{{ s.localitatea|default:"‚Äî" }}</div>
      </div>
      <div>
        <strong>Silvice</strong>
        <div class="muted" data-f="silvice">{{ s.silvice|yesno:"Da,Nu" }}</div>
      </div>
      <div>
        <strong>Paji»ôti/stepice</strong>
        <div class="muted" data-f="pajisti_sau_stepice">{{ s.pajisti_sau_stepice|yesno:"Da,Nu" }}</div>
      </div>
      <div>
        <strong>St√¢ncƒÉrii</strong>
        <div class="muted" data-f="stancarii">{{ s.stancarii|yesno:"Da,Nu" }}</div>
      </div>
      <div>
        <strong>Palustre/acvatice</strong>
        <div class="muted" data-f="palustre_si_acvatice">{{ s.palustre_si_acvatice|yesno:"Da,Nu" }}</div>
      </div>
      <div>
        <strong>Conventia Berna</strong>
        <div class="muted" data-f="conventia_berna">{{ s.conventia_berna|yesno:"Da,Nu" }}</div>
      </div>
      <div>
        <strong>Directiva Habitate</strong>
        <div class="muted" data-f="directiva_habitate">{{ s.directiva_habitate|yesno:"Da,Nu" }}</div>
      </div>
      <div>
        <strong>Cartea Ro»ôie (an)</strong>
        <div class="muted" data-f="cartea_rosie">{{ s.cartea_rosie|default:"‚Äî" }}</div>
      </div>
      <div>
        <strong>Categoria</strong>
        <div class="muted" data-f="cartea_rosie_cat">{{ s.cartea_rosie_cat|default:"‚Äî" }}</div>
      </div>
      <div>
        <strong>Frecven»õƒÉ</strong>
        <div class="muted" data-f="frecventa">{{ s.frecventa|default:"‚Äî" }}</div>
      </div>
    </div>

    {% if s.notes %}
    <div class="mt-4">
      <strong>Note</strong>
      <div class="muted" data-f="notes">{{ s.notes }}</div>
    </div>
    {% endif %}

    <div class="mt-3" style="display:flex; gap:8px; justify-content:space-between; align-items:center;">
      <a href="{% url 'viz_specii' %}" class="btn btn-outline">√énapoi la specii</a>
      {% if is_admin %}
      <button id="actionBtn" class="btn" aria-label="EditeazƒÉ"><span aria-hidden="true">‚úé</span> Edit</button>
      {% endif %}
    </div>
  </div>
  {% if s.is_rare and points and points|length > 0 %}
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <div id="species-map" style="width:100%; height:520px; margin-top:16px; border-radius:12px; overflow:hidden; box-shadow: var(--shadow);"></div>
  {% endif %}
</section>

{% block extra_css %}
<style>
  /* Card expansion and responsive grid */
  #species-card {
    transition: height 120ms ease;
  }
  
  /* Responsive grid - long fields span 2 columns on larger screens */
  @media (min-width: 768px) {
    #species-meta[data-edit-mode="true"] {
      grid-template-columns: repeat(4, 1fr);
    }
    #species-meta[data-edit-mode="true"] [data-span="2"] {
      grid-column: span 2;
    }
  }
  
  /* Allow very long fields to span full row if needed */
  #species-meta[data-edit-mode="true"] .span-full-row {
    grid-column: 1 / -1;
  }
  
  /* Ensure inputs are full width and properly styled */
  #species-meta input,
  #species-meta textarea,
  #species-meta select {
    width: 100% !important;
    box-sizing: border-box;
    min-width: 0; /* Allow flex items to shrink below content size */
  }
  
  /* Ensure grid items don't overflow */
  #species-meta > div {
    min-width: 0;
    overflow: hidden;
    max-width: 100%;
    word-wrap: break-word;
    word-break: break-all;
  }
  
  /* Smooth transitions for input height changes */
  #species-meta textarea {
    transition: height 120ms ease;
    word-break: break-word;
    white-space: pre-wrap;
    overflow-wrap: anywhere;
    hyphens: auto;
  }
  
  /* Ensure long text wraps properly in both view and edit modes */
  #species-meta .muted {
    white-space: normal;
    overflow-wrap: anywhere;
    word-break: break-word;
    hyphens: auto;
    max-width: 100%;
    overflow: hidden;
  }
  
  /* Prevent horizontal overflow in the grid */
  #species-meta {
    overflow: hidden;
  }
  
  /* Ensure textareas don't cause horizontal overflow */
  #species-meta textarea {
    max-width: 100%;
    overflow-x: hidden;
    overflow-y: hidden;
  }
  
  /* Force text wrapping for very long strings */
  #species-meta .muted,
  #species-meta textarea {
    word-break: break-all;
    overflow-wrap: break-word;
  }
  
  /* Ensure grid items respect column boundaries */
  #species-meta > div {
    max-width: 100%;
    word-wrap: break-word;
  }
</style>
{% endblock %}

{% block extra_js %}
  <script>
    (function(){
      var card = document.getElementById('species-card');
      var desc = document.getElementById('species-desc');
      var meta = document.getElementById('species-meta');
      var btn = document.getElementById('actionBtn');

      function autosize(textarea){
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 360) + 'px';
      }
      function toast(msg){
        var t = document.createElement('div');
        t.setAttribute('role','status');
        t.style.position='fixed'; t.style.right='16px'; t.style.bottom='16px'; t.style.background='#0d2214'; t.style.color='#fff'; t.style.padding='10px 14px'; t.style.borderRadius='10px'; t.style.boxShadow='var(--shadow)';
        t.textContent = msg; document.body.appendChild(t); setTimeout(()=>{ t.remove(); }, 1800);
      }
      function getCookie(name){ var m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)'); return m ? m.pop() : ''; }
      function buildGuardModal(){
        var wrap = document.createElement('div');
        wrap.id='unsaved-guard';
        wrap.innerHTML = '<div style="position:fixed; inset:0; background:rgba(0,0,0,.28); display:flex; align-items:center; justify-content:center; z-index:9999;">\n  <div role="dialog" aria-modal="true" style="background:#fff; color:var(--text); max-width:520px; width:92%; border-radius:12px; box-shadow:var(--shadow); padding:16px;">\n    <h3 style="margin:0 0 8px; font-size:1.1rem;">You have unsaved changes</h3>\n    <p class="muted" style="margin:0 0 12px;">Save before leaving?</p>\n    <div style="display:flex; gap:8px; justify-content:flex-end;">\n      <button type="button" id="guard-stay" class="btn btn-outline">Stay</button>\n      <button type="button" id="guard-discard" class="btn btn-outline">Discard</button>\n      <button type="button" id="guard-save" class="btn">Save and leave</button>\n    </div>\n  </div>\n</div>';
        return wrap;
      }

      // Global state
      var mode = 'VIEW'; // VIEW | EDITING | SAVING
      var originalValues = {}; // raw originals for UI restore
      var initialValues = {};  // immutable snapshot for dirty checks
      var inputs = {};
      var dirty = false;
      var beforeUnloadHandler = null;
      var internalNavHandler = null;
      var keydownHandler = null;

      // Normalize history to a clean VIEW state on load
      try { history.replaceState({}, '', location.href); } catch(_) {}
      window.addEventListener('popstate', function(){
        // Always force view mode if any edit state lingered
        meta.removeAttribute('data-edit-mode');
        mode = 'VIEW';
      });

      // Single click handler that branches by mode
      btn.addEventListener('click', function(ev) {
        ev.preventDefault();
        if (mode === 'VIEW') {
          enterEdit();
        } else if (mode === 'EDITING') {
          doSave();
        }
        // SAVING mode: button is disabled, no action
      });

      // Convert metadata fields to inputs
      function createInput(field, type, placeholder) {
        var el = meta.querySelector('[data-f="' + field + '"]');
        var val = (el.textContent.trim() === '‚Äî') ? '' : el.textContent.trim();
        originalValues[field] = val;
        
        var input;
        if (type === 'text') {
          // Use textarea for text fields with autosizing
          input = document.createElement('textarea');
          input.rows = 1;
          input.style.cssText = 'width:100%; padding:8px; border:1px solid var(--line); border-radius:8px; font-family:inherit; font-size:inherit; resize:none; overflow:hidden; line-height:1.5; transition:height 120ms ease; word-break:break-all; white-space:pre-wrap; overflow-wrap:break-word; hyphens:auto; max-width:100%; overflow-x:hidden; overflow-y:hidden; word-wrap:break-word;';
          autosize(input);
        } else if (type === 'boolean') {
          // Use select for boolean fields
          input = document.createElement('select');
          input.style.cssText = 'width:100%; padding:8px; border:1px solid var(--line); border-radius:8px; font-family:inherit; font-size:inherit;';
          input.innerHTML = '<option value="">‚Äî</option><option value="true">Da</option><option value="false">Nu</option>';
          input.value = val === 'Da' ? 'true' : val === 'Nu' ? 'false' : '';
        } else {
          // Use input for other fields
          input = document.createElement('input');
          input.type = type;
          input.style.cssText = 'width:100%; padding:8px; border:1px solid var(--line); border-radius:8px; font-family:inherit; font-size:inherit;';
        }
        
        input.name = field;
        input.placeholder = placeholder || '';
        if (type !== 'boolean') {
          input.value = val;
        }
        
        el.replaceWith(input);
        inputs[field] = input;
        
        input.addEventListener('input', function(){ 
          computeDirty();
          updateSaveButton();
          if (type === 'text') autosize(input);
        });
      }

      // Autosize function for textareas
      function autosize(textarea) {
        textarea.style.height = 'auto';
        var scrollHeight = textarea.scrollHeight;
        var lineHeight = parseFloat(getComputedStyle(textarea).lineHeight);
        var minHeight = lineHeight;
        textarea.style.height = Math.max(scrollHeight, minHeight) + 'px';
        
        // If textarea is very tall, make it span full row
        var parentDiv = textarea.closest('div');
        if (parentDiv && scrollHeight > 200) {
          parentDiv.classList.add('span-full-row');
        } else if (parentDiv) {
          parentDiv.classList.remove('span-full-row');
        }
      }

      function setLoading(on) {
        btn.disabled = !!on;
        btn.innerHTML = on ? '<span aria-hidden="true">‚è≥</span> Saving‚Ä¶' : '<span aria-hidden="true">üíæ</span> Save';
        Object.values(inputs).forEach(function(input) { input.disabled = !!on; });
      }

      // Normalization helper for comparisons
      function normalizeText(value){
        if (value == null) return '';
        var s = String(value);
        s = s.replace(/\r\n?|\u2028|\u2029/g, '\n');
        s = s.split('\n').map(function(line){ return line.replace(/\s+/g, ' ').trim(); }).join('\n');
        return s.trim();
      }

      function snapshotInitialValues(){
        initialValues = {};
        for (var field in inputs){
          if (inputs[field].type === 'select-one') {
            var val = inputs[field].value;
            initialValues[field] = val === 'true' ? 'Da' : val === 'false' ? 'Nu' : '';
          } else {
            initialValues[field] = normalizeText(inputs[field].value || '');
          }
        }
      }

      function computeDirty(){
        var wasDirty = dirty;
        dirty = false;
        for (var field in inputs){
          var curr;
          if (inputs[field].type === 'select-one') {
            var val = inputs[field].value;
            curr = val === 'true' ? 'Da' : val === 'false' ? 'Nu' : '';
          } else {
            curr = normalizeText(inputs[field].value || '');
          }
          if (curr !== (initialValues[field] || '')){ dirty = true; break; }
        }
        if (dirty !== wasDirty) updateGuards();
      }

      function updateSaveButton(){
        // Keep Save enabled in EDITING regardless of dirty; only disable if not in EDITING
        btn.disabled = mode !== 'EDITING';
      }

      // Enter edit mode
      function enterEdit() {
        mode = 'EDITING';
        
        // Set edit mode attribute for CSS
        meta.setAttribute('data-edit-mode', 'true');
        
        // Create all inputs
        createInput('denumire_populara', 'text', 'Nume popular');
        createInput('clasa', 'text', 'ClasƒÉ');
        createInput('familia', 'text', 'Familie');
        createInput('habitat', 'text', 'Habitat');
        createInput('localitatea', 'text', 'Localitatea');
        createInput('silvice', 'boolean');
        createInput('pajisti_sau_stepice', 'boolean');
        createInput('stancarii', 'boolean');
        createInput('palustre_si_acvatice', 'boolean');
        createInput('conventia_berna', 'boolean');
        createInput('directiva_habitate', 'boolean');
        createInput('cartea_rosie', 'number', 'Anul');
        createInput('cartea_rosie_cat', 'text', 'Categoria');
        createInput('frecventa', 'text', 'Frecven»õa');
        createInput('notes', 'text', 'Note');

        // Toggle the same button to Save mode
        btn.innerHTML = '<span aria-hidden="true">üíæ</span> Save';
        btn.setAttribute('aria-label', 'SalveazƒÉ modificƒÉrile');

        // Focus first input
        inputs.denumire_populara.focus();
        
        // Ensure all textareas expand to fit content immediately after render
        requestAnimationFrame(function() {
          Object.values(inputs).forEach(function(input) {
            if (input.tagName === 'TEXTAREA') {
              autosize(input);
            }
          });
        });

        // Snapshot and initialize guards
        snapshotInitialValues();
        computeDirty();
        updateSaveButton();
        updateGuards();

        // Keyboard shortcuts
        keydownHandler = function(e) {
          if ((e.ctrlKey || e.metaKey) && e.key === 'Enter' && !btn.disabled) {
            btn.click();
          }
          if (e.key === 'Escape') {
            cancelEdit();
          }
        };
        document.addEventListener('keydown', keydownHandler);
      }

      // Cancel edit mode
      function cancelEdit() {
        detachBeforeUnload();
        detachInternalNavGuard();
        if (keydownHandler) { document.removeEventListener('keydown', keydownHandler); keydownHandler = null; }
        // Remove edit mode attribute
        meta.removeAttribute('data-edit-mode');
        // Restore original display
        for (var field in inputs) {
          var display = document.createElement('div');
          display.className = 'muted';
          display.setAttribute('data-f', field);
          display.textContent = (originalValues[field] || '') === '' ? '‚Äî' : originalValues[field];
          inputs[field].replaceWith(display);
        }
        // Restore Edit button
        btn.innerHTML = '<span aria-hidden="true">‚úé</span> Edit';
        btn.setAttribute('aria-label', 'EditeazƒÉ');
        // Clean state
        mode = 'VIEW';
        dirty = false;
        try { history.replaceState({}, '', location.href); } catch(_) {}
      }

      // Save function
      async function doSave() {
        // Recompute dirty at click time
        computeDirty();
        if (!dirty) {
          // No-op save: treat as success and exit edit mode cleanly
          detachBeforeUnload();
          detachInternalNavGuard();
          if (keydownHandler) { document.removeEventListener('keydown', keydownHandler); keydownHandler = null; }
          toast('Saved');
          meta.removeAttribute('data-edit-mode');
          
          // Replace all inputs with read-only values
          for (var field in inputs) {
            var display = document.createElement('div');
            display.className = 'muted';
            display.setAttribute('data-f', field);
            var currentVal = inputs[field].value.trim();
            if (inputs[field].type === 'select-one') {
              currentVal = currentVal === 'true' ? 'Da' : currentVal === 'false' ? 'Nu' : '';
            }
            display.textContent = currentVal === '' ? '‚Äî' : currentVal;
            inputs[field].replaceWith(display);
          }
          
          // Restore Edit button
          btn.innerHTML = '<span aria-hidden="true">‚úé</span> Edit';
          btn.setAttribute('aria-label', 'EditeazƒÉ');
          mode = 'VIEW';
          dirty = false;
          try { history.replaceState({}, '', location.href); } catch(_) {}
          return;
        }

        mode = 'SAVING';
        setLoading(true);
        try {
          var fd = new FormData();
          // Send only changed fields
          for (var field in inputs) {
            var val = (inputs[field].value || '').trim();
            if (inputs[field].type === 'select-one') {
              val = val === 'true' ? 'true' : val === 'false' ? 'false' : '';
            }
            fd.append(field, val);
          }
          
          const resp = await fetch('{% url "update_species_meta" s.id %}', {
            method: 'POST',
            headers: {
              'X-Requested-With': 'fetch',
              'X-CSRFToken': getCookie('csrftoken')
            },
            body: fd
          });
          
          if (!resp.ok) {
            var errorData = await resp.json();
            throw new Error(errorData.error || 'Save failed');
          }
          
          const data = await resp.json();
          
          // Update UI with new values
          for (var field in data.changed || {}) {
            var display = document.createElement('div');
            display.className = 'muted';
            display.setAttribute('data-f', field);
            var val = data.changed[field];
            if (field in ['silvice', 'pajisti_sau_stepice', 'stancarii', 'palustre_si_acvatice', 'conventia_berna', 'directiva_habitate']) {
              display.textContent = val ? 'Da' : 'Nu';
            } else {
              display.textContent = (val == null || val === '') ? '‚Äî' : val;
            }
            inputs[field].replaceWith(display);
          }
          
          detachBeforeUnload();
          detachInternalNavGuard();
          if (keydownHandler) { document.removeEventListener('keydown', keydownHandler); keydownHandler = null; }
          toast('Saved');
          
          // Remove edit mode attribute
          meta.removeAttribute('data-edit-mode');
          // Restore all fields to display mode
          for (var field in inputs) {
            var display = document.createElement('div');
            display.className = 'muted';
            display.setAttribute('data-f', field);
            var currentVal = inputs[field].value.trim();
            if (inputs[field].type === 'select-one') {
              currentVal = currentVal === 'true' ? 'Da' : currentVal === 'false' ? 'Nu' : '';
            }
            display.textContent = currentVal === '' ? '‚Äî' : currentVal;
            inputs[field].replaceWith(display);
          }
          // Restore Edit button
          btn.innerHTML = '<span aria-hidden="true">‚úé</span> Edit';
          btn.setAttribute('aria-label', 'EditeazƒÉ');
          // Refresh snapshot and state
          snapshotInitialValues();
          dirty = false;
          mode = 'VIEW';
          updateGuards();
          try { history.replaceState({}, '', location.href); } catch(_) {}
        } catch (e) {
          toast('Save error: ' + e.message);
        } finally {
          setLoading(false);
          if (mode === 'SAVING') { mode = 'EDITING'; updateGuards(); }
        }
      }

      // Guards attach/detach
      function attachBeforeUnload(){
        if (beforeUnloadHandler) return;
        beforeUnloadHandler = function(e){ if (dirty && mode === 'EDITING'){ e.preventDefault(); e.returnValue = ''; } };
        window.addEventListener('beforeunload', beforeUnloadHandler);
      }
      function detachBeforeUnload(){
        if (!beforeUnloadHandler) return;
        window.removeEventListener('beforeunload', beforeUnloadHandler);
        beforeUnloadHandler = null;
      }
      function attachInternalNavGuard(){
        if (internalNavHandler) return;
        internalNavHandler = function(e){
          var a = e.target.closest('a');
          if (!a) return;
          if (!dirty || mode !== 'EDITING') return;
          e.preventDefault();
          var m = buildGuardModal();
          document.body.appendChild(m);
          m.querySelector('#guard-stay').focus();
          m.querySelector('#guard-stay').onclick = function(){ m.remove(); };
          m.querySelector('#guard-discard').onclick = function(){
            detachBeforeUnload();
            document.removeEventListener('click', internalNavHandler, true); internalNavHandler = null;
            window.location.href = a.href;
          };
          m.querySelector('#guard-save').onclick = async function(){ await doSave(true, a.href); };
        };
        document.addEventListener('click', internalNavHandler, true);
      }
      function detachInternalNavGuard(){
        if (!internalNavHandler) return;
        document.removeEventListener('click', internalNavHandler, true);
        internalNavHandler = null;
      }
      function updateGuards(){
        if (dirty && mode === 'EDITING') { attachBeforeUnload(); attachInternalNavGuard(); }
        else { detachBeforeUnload(); detachInternalNavGuard(); }
      }
    })();
  </script>
  {% if s.is_rare and points and points|length > 0 %}
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
  {{ points|json_script:"species-points-data" }}
  <script>
    (function(){
      if (!document.getElementById('species-map')) return;
      if (window.__speciesMapInit) return; window.__speciesMapInit = true;
      var points = JSON.parse(document.getElementById('species-points-data').textContent);
      var mdCenter = [47.0, 28.5];
      var map = L.map('species-map', { center: mdCenter, zoom: 7, scrollWheelZoom: true });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
      var bounds = [];
      points.forEach(function(p){ var m = L.marker([p.lat, p.lon]).addTo(map); if (p.label) { m.bindPopup(p.label); } bounds.push([p.lat, p.lon]); });
      if (bounds.length > 0) { map.fitBounds(bounds, { padding: [30,30], maxZoom: 11 }); }
    })();
  </script>
  {% endif %}
{% endblock %}
{% endblock %}
